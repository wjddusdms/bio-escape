<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BIO-MASTER: TOTAL RECOVERY v8.1</title>
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ (ì ˆëŒ€ ìˆ˜ì • ê¸ˆì§€ ì›ì¹™ ì¤€ìˆ˜) */
        :root { 
            --neon-s1: #00ffcc; --neon-s2: #00d4ff; --gold: #ffcc00; 
            --blood-red: #ff4d4d; --bg: #050a10; --panel: #0d1624; 
            --danger: #ff4444; --safe: #00ff88; --warning: #ffaa00;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; display: flex; justify-content: center; min-height: 100vh; overflow-x: hidden; }
        #game-frame { width: 100%; max-width: 600px; background: var(--panel); position: relative; display: flex; flex-direction: column; border-left: 2px solid var(--neon-s1); border-right: 2px solid var(--neon-s1); min-height: 100vh; transition: border 0.5s; }
        #status-bar { background: rgba(0,255,204,0.1); padding: 15px; display: flex; justify-content: space-between; border-bottom: 1px solid var(--neon-s1); position: sticky; top: 0; z-index: 100; font-size: 0.8rem; }
        #repair-progress-container { display: none; width: 100%; height: 8px; background: #111; border-bottom: 1px solid var(--neon-s2); }
        #repair-progress-fill { width: 0%; height: 100%; background: var(--safe); transition: 0.5s; box-shadow: 0 0 10px var(--safe); }
        .node-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; padding-bottom: 300px; flex-grow: 1; overflow-y: auto; }
        .node { height: 85px; border: 1px solid var(--neon-s1); border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; background: rgba(0,255,204,0.02); font-size: 0.75rem; text-align: center; position: relative; transition: 0.3s; padding: 5px; }
        .node.solved { opacity: 0.15; pointer-events: none; filter: grayscale(1); }
        .node.locked { border-color: var(--danger); background: rgba(255, 68, 68, 0.15); color: var(--danger); animation: shake 0.3s; }
        .node.wait-tune { border-color: var(--warning); filter: sepia(1); cursor: not-allowed; opacity: 0.5; }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }
        #inventory-panel { position: fixed; bottom: 0; width: 100%; max-width: 600px; background: #000; border-top: 2px solid var(--gold); padding: 8px 15px; z-index: 900; height: 180px; display: flex; flex-direction: column; }
        .archive-box { border: 1px solid #333; padding: 5px; margin-bottom: 3px; border-radius: 4px; }
        .hint-text { color: var(--gold); font-family: monospace; font-size: 0.75rem; letter-spacing: 1px; }
        #s2-slots { display: none; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 5px; overflow-y: auto; flex-grow: 1; padding-bottom: 5px; }
        .slot { border: 1px solid #333; height: 42px; display: flex; align-items: center; justify-content: center; font-size: 0.55rem; color: #555; border-radius: 4px; cursor: pointer; text-align: center; line-height: 1.1; min-height: 42px; }
        .slot.has-item { border-color: var(--gold); color: #fff; background: rgba(255,204,0,0.1); }
        .slot.selected { border-color: #fff; box-shadow: 0 0 10px #fff; background: rgba(255,255,255,0.2); color: #fff; }
        #homeo-monitor { display: none; background: #000; padding: 12px; border-bottom: 2px solid var(--gold); flex-direction: column; gap: 8px; }
        .gauge-container { display: flex; align-items: center; gap: 10px; }
        .label { width: 55px; color: var(--gold); font-size: 0.75rem; font-weight: bold; }
        .bar-bg { flex: 1; height: 16px; background: #222; border-radius: 8px; position: relative; overflow: hidden; border: 1px solid #444; }
        .bar-fill { height: 100%; width: 50%; background: var(--safe); transition: 0.4s; }
        .center-line { position: absolute; left: 40%; width: 20%; height: 100%; background: rgba(0, 255, 136, 0.1); border-left: 1px dashed #fff; border-right: 1px dashed #fff; z-index: 5; }
        .dead-zone { position: absolute; width: 8%; height: 100%; background: rgba(255,0,0,0.4); z-index: 2; }
        #section-tabs { display: none; background: #000; border-bottom: 1px solid #333; }
        .tab { flex: 1; padding: 12px; text-align: center; font-size: 0.7rem; cursor: pointer; color: #555; transition: 0.3s; }
        .tab.active { color: var(--gold); background: rgba(255,204,0,0.1); font-weight: bold; border-bottom: 2px solid var(--gold); }
        #intro-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 5000; display: flex; flex-direction: column; padding: 30px; justify-content: center; }
        .story-text { font-family: 'Courier New', monospace; color: var(--neon-s1); line-height: 1.8; margin-bottom: 25px; border-left: 3px solid var(--neon-s1); padding-left: 15px; font-size: 0.9rem; white-space: pre-wrap; }
        .gate-btn { position: fixed; bottom: 190px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 540px; background: var(--danger); color: white; padding: 15px; border: none; border-radius: 10px; font-weight: bold; z-index: 1000; cursor: pointer; }
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 6000; justify-content: center; align-items: center; }
        .modal { background: #0d1117; border: 2px solid var(--neon-s1); padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; }
        .opt-btn { width: 100%; padding: 14px; margin: 6px 0; background: #1c2128; border: 1px solid #333; color: #fff; border-radius: 8px; cursor: pointer; }
        input { width: 100%; padding: 14px; background: #000; border: 1px solid var(--neon-s1); color: #fff; border-radius: 8px; margin: 8px 0; text-align: center; font-size: 1.2rem; }
        .confirm-btn { width: 100%; padding: 22px; background: var(--neon-s1); color: #000; border: none; font-weight: 900; border-radius: 12px; cursor: pointer; font-size: 1.4rem; margin-top: 10px; box-shadow: 0 0 15px var(--neon-s1); transition: 0.2s; }
        #s3-controls { display: none; gap: 10px; width: 100%; max-width: 400px; margin-top: 10px; }
        .act-btn { flex: 1; padding: 12px; border: 1px solid var(--gold); color: var(--gold); background: none; font-size: 0.8rem; cursor: pointer; border-radius: 5px; font-weight: bold; }
        .act-btn:disabled { border-color: #333; color: #444; opacity: 0.4; }
        #exit-btn { display: none; background: var(--safe); color: #000; width: 100%; max-width: 400px; padding: 15px; border: none; font-weight: bold; margin-top: 10px; cursor: pointer; border-radius: 5px; }
        #s4-container { display: none; flex-direction: column; width: 100%; height: 100%; }
        #s4-canvas-container { position: relative; width: 100%; height: 300px; background: #1a0505; overflow: hidden; border-bottom: 2px solid var(--blood-red); }
        #game-canvas { width: 100%; height: 100%; display: block; }
        #s4-shop { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; padding: 10px; background: #000; flex-grow: 1; overflow-y: auto; }
        .shop-item { background: #111; border: 1px solid #333; padding: 8px; border-radius: 6px; cursor: pointer; }
        .shop-item.selected { border-color: var(--blood-red); background: #2a0a0a; }
        .shop-item b { color: var(--blood-red); font-size: 0.8rem; display: block; }
        .shop-item p { font-size: 0.6rem; margin: 3px 0; color: #aaa; line-height: 1.2; }
    </style>
</head>
<body>

<div id="game-frame">
    <div id="status-bar"><span id="sys-name">ST-1: BIOLOGICAL PROOF</span><span id="score">RECOVERY: 0 / 20</span></div>
    <div id="repair-progress-container"><div id="repair-progress-fill"></div></div>
    
    <div id="std-view" style="display: flex; flex-direction: column; flex-grow: 1;">
        <div id="homeo-monitor">
            <div class="gauge-container"><div class="label">í˜ˆë‹¹ëŸ‰</div><div class="bar-bg"><div id="bar-glu" class="bar-fill"></div><div class="center-line"></div><div class="dead-zone" style="left:0;"></div><div class="dead-zone" style="right:0;"></div></div></div>
            <div class="gauge-container"><div class="label">ì‚¼íˆ¬ì••</div><div class="bar-bg"><div id="bar-osm" class="bar-fill"></div><div class="center-line"></div><div class="dead-zone" style="left:0;"></div><div class="dead-zone" style="right:0;"></div></div></div>
            <div class="gauge-container"><div class="label">ì²´ ì˜¨</div><div class="bar-bg"><div id="bar-tem" class="bar-fill"></div><div class="center-line"></div><div class="dead-zone" style="left:0;"></div><div class="dead-zone" style="right:0;"></div></div></div>
        </div>
        <div id="section-tabs"><div class="tab active" id="tab-glu" onclick="switchTabS3('GLU')">í˜ˆë‹¹</div><div class="tab" id="tab-osm" onclick="switchTabS3('OSM')">ì‚¼íˆ¬ì••</div><div class="tab" id="tab-tem" onclick="switchTabS3('TEM')">ì²´ì˜¨</div></div>
        <div id="node-grid" class="node-container"></div>
    </div>

    <div id="s4-container">
        <div id="s4-canvas-container"><canvas id="game-canvas"></canvas></div>
        <div id="s4-shop">
            <div class="shop-item" id="shop-macro" onclick="selectTowerS4('macro')"><b>ğŸ›¡ï¸ ëŒ€ì‹ì„¸í¬ (40 BP)</b><p>ì‹ê·  ì‘ìš©: ê·¼ì²˜ ì ì„ ì¡ì•„ë¨¹ì–´ ê°ì† ë° ì§€ì† í”¼í•´.</p></div>
            <div class="shop-item" id="shop-ht" onclick="selectTowerS4('ht')"><b>ğŸ“¢ ë³´ì¡°Tì„¸í¬ (50 BP)</b><p>ë©´ì—­ ì§€íœ˜: ì£¼ë³€ íƒ€ì›Œì˜ ì‚¬ê±°ë¦¬ë¥¼ ì¦í­.</p></div>
            <div class="shop-item" id="shop-tc" onclick="selectTowerS4('tc')"><b>âš”ï¸ ë…ì„±Tì„¸í¬ (60 BP)</b><p>ì„¸í¬ì„± ë©´ì—­: ë‹¨ì¼ ëŒ€ìƒì—ê²Œ ë§¤ìš° ê°•ë ¥í•œ íƒ€ê²©.</p></div>
            <div class="shop-item" id="shop-bc" onclick="selectTowerS4('bc')"><b>ğŸ¹ í˜•ì§ˆì„¸í¬ (80 BP)</b><p>ì²´ì•¡ì„± ë©´ì—­: ë²”ìœ„ ë‚´ ëª¨ë“  ì ì—ê²Œ ê´‘ì—­ ê°ì† ë° í”¼í•´.</p></div>
        </div>
    </div>

    <button id="action-btn" class="gate-btn" onclick="openFinalS1()">ğŸ”‘ ê²©ë¦¬ êµ¬ì—­ ì ê¸ˆ í•´ì œ (FINAL)</button>
    
    <div id="inventory-panel">
        <div id="ai-status" style="font-size:0.6rem; color:var(--neon-s1); margin-bottom:2px;">AI STATUS: ë¶„ì„ ëŒ€ê¸° ì¤‘...</div>
        <div id="s1-hints"><div class="archive-box"><span id="text-hints" class="hint-text">_ _ _ _ _ _</span></div><div class="archive-box"><span id="data-hints" class="hint-text">ğŸ¨:? | ğŸ”¤:? | ğŸ”¢:? ? ?</span></div><div class="archive-box"><span id="metab-hints" class="hint-text">CORE: ? ? ? ?</span></div></div>
        <div id="s2-slots"><script>for(let i=0; i<16; i++) document.write(`<div class="slot" id="slot${i}" onclick="selectItemS2(${i})">EMPTY</div>`);</script></div>
        <div id="s3-controls"><button id="btn-up" class="act-btn" disabled onclick="tuneS3(18)">ë†’ì´ê¸° (+18%)</button><button id="btn-down" class="act-btn" disabled onclick="tuneS3(-18)">ë‚®ì¶”ê¸° (-18%)</button><button id="exit-btn" onclick="transitionToS4()">ğŸ ì—”ì§„ ìµœì í™” ì™„ë£Œ</button></div>
        <div id="s4-controls" style="display:none; flex-direction:column; gap:5px;">
            <div id="s4-question" style="font-size:0.65rem; color:var(--blood-red); height:35px; overflow:hidden;">ì§ˆë¬¸ ë¡œë”©...</div>
            <div style="display:flex; gap:5px;"><input type="text" id="ans-s4" placeholder="í‚¤ì›Œë“œ ì…ë ¥" style="margin:0; flex-grow:1; padding:8px; font-size:0.8rem;"><button onclick="passQuizS4()" style="background:#444; border:none; color:#fff; padding:0 10px; border-radius:5px; font-size:0.7rem;">SKIP</button></div>
            <button id="w-btn" onclick="startWaveS4()" style="background:var(--blood-red); border:none; color:#fff; padding:8px; border-radius:5px; font-weight:bold; font-size:0.8rem; margin-top:5px;">WAVE ì‹œì‘</button>
        </div>
    </div>
</div>

<div id="intro-overlay"><div class="story-text" id="type-text"></div><button id="intro-btn" style="display:none; background:var(--neon-s1); color:#000; border:none; padding:15px; font-weight:bold; border-radius:5px; cursor:pointer;" onclick="closeIntro()">í”„ë¡œí† ì½œ ì‹œì‘</button></div>
<div id="modal-overlay"><div id="modal-content" class="modal"></div></div>

<script>
    /* ë¡œì§ ë°ì´í„° ì„¹ì…˜ */
    let currentStage = 1;
    let solvedCount = 0;
    let inventoryS2 = Array(16).fill(null);
    let selectedIdxS2 = null;
    let currentTabS3 = 'GLU';
    let solvedS3 = { GLU: new Set(), OSM: new Set(), TEM: new Set() };
    let statsS3 = { GLU: 75, OSM: 20, TEM: 80 };
    let waitTuneS3 = false;

    // Stage 4 
    let bioPointsS4 = 0; let infectionHpS4 = 10; let waveNumS4 = 1; let currentQuizIdxS4 = 0; let quizInWaveS4 = 0;
    let selectedTowerS4 = null; let towersS4 = []; let enemiesS4 = []; let waveActiveS4 = false;
    let deathEffectsS4 = []; let tilesS4 = []; const tileSizeS4 = 40;
    const pathNodesS4 = [{x:0,y:150},{x:100,y:150},{x:100,y:50},{x:300,y:50},{x:300,y:250},{x:500,y:250},{x:500,y:100},{x:600,y:100}];

    /* [ëª…ë ¹ ë°˜ì˜] ë©˜íŠ¸ ìµœì í™” */
    const introS1 = "ëˆˆì„ ëœ¨ì‹­ì‹œì˜¤, Subject Genesis.\n\në‹¹ì‹ ì€ ê¸°ì–µì´ ì†Œê±°ëœ ì±„ ë°°ì–‘ íƒ±í¬ì—ì„œ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì‹œìŠ¤í…œ 'ë°”ì´ì˜¤'ëŠ” ë‹¹ì‹ ì´ ì‚´ ê°€ì¹˜ê°€ ìˆëŠ” 'ì§€ì  ìƒëª…ì²´'ì¸ì§€ ê²€ì¦í•˜ë ¤ í•©ë‹ˆë‹¤.\n\në¨¼ì € ê¸°ì´ˆ ìƒë¬¼í•™ì  ì¸ì§€ ëŠ¥ë ¥ì„ ì¦ëª…í•˜ì‹­ì‹œì˜¤. ì‹¤íŒ¨ëŠ” ì¦‰ì‹œ íê¸°ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.";
    const outroS1 = "ë°”ì´ì˜¤: \"ì¸ì§€ ëŠ¥ë ¥ ê²€ì¦ ì™„ë£Œ. í•˜ë“œì›¨ì–´ì˜ ê¸°ì´ˆ ë³µêµ¬ë¥¼ ìŠ¹ì¸í•œë‹¤. í•˜ì§€ë§Œ ì•„ì§ ë„¤ ì˜ì‹ì€ ë¶ˆì•ˆì •í•˜êµ°. ë‹¤ìŒ êµ¬ì—­ìœ¼ë¡œ ì´ë™í•´ë¼.\"";
    
    const introS2 = "ë°”ì´ì˜¤: \"íšŒë¡œê°€ ì²˜ì°¸í•˜ê²Œ ë§ê°€ì¡Œêµ°. ì‹ ê²½ë§ì„ ì¬ê±´í•´ì•¼ í•œë‹¤.\n\ní•˜ë‹¨ ì¸ë²¤í† ë¦¬ì—ì„œ ì ì ˆí•œ 'ì‹ ê²½ ì „ë‹¬ ë¬¼ì§ˆ'ê³¼ 'ë°˜ì‚¬ ëª¨ë“ˆ'ì„ ì¥ì°©í•´ ë…¸ë“œë¥¼ ìˆ˜ë¦¬í•´ë¼. ì—‰ëš±í•œ ì¥ë¹„ë¥¼ ì‚¬ìš©í•˜ë©´ ë„¤ ì‹ ê²½ê³„ëŠ” ì˜êµ¬ì ìœ¼ë¡œ íƒ€ë²„ë¦´ ê²ƒì´ë‹¤.\"";
    const outroS2 = "ë°”ì´ì˜¤: \"ì‹ ê²½ê³„ í•˜ë“œì›¨ì–´ ë³µêµ¬ ì„±ê³µ. ì´ì œ ë„¤ ì‹ ì²´ëŠ” ì™¸ë¶€ ìê·¹ì— ë°˜ì‘í•  ìˆ˜ ìˆê²Œ ë˜ì—ˆë‹¤. í•˜ì§€ë§Œ ì‹œìŠ¤í…œì˜ 'ê· í˜•'ì´ ë¬´ë„ˆì§„ ìƒíƒœë‹¤. ì—”ì§„ì‹¤ë¡œ ê°€ë¼.\"";
    
    const introS3 = "ë°”ì´ì˜¤: \"ì‹ ê²½ì´ ì—°ê²°ë˜ì—ˆìœ¼ë‹ˆ ì—”ì§„ì„ ëŒë¦´ ì°¨ë¡€ë‹¤. í•˜ì§€ë§Œ ìƒì²´ ì—”ì§„ì€ ë§¤ìš° ì˜ˆë¯¼í•˜ì§€.\n\ní˜ˆë‹¹, ì‚¼íˆ¬ì••, ì²´ì˜¨... í‰í˜• ìˆ˜ì¹˜ë¥¼ ë°ë“œì¡´ì— ë‹¿ê²Œ ë‘ì§€ ë§ˆë¼. ì—”ì§„ì´ ê³¼ë¶€í•˜ë˜ë©´ ë„¤ ì¡´ì¬ ìì²´ë„ ì…§ë‹¤ìš´ëœë‹¤. ëª¨ë“  ìˆ˜ì¹˜ë¥¼ 'SAFE' ì˜ì—­ìœ¼ë¡œ ê³ ì •í•´ë¼.\"";
    const outroS3 = "ë°”ì´ì˜¤: \"ì‹œìŠ¤í…œ ìµœì í™” ì™„ë£Œ. ì´ì œ ë„Œ ì–´ë–¤ ê°€í˜¹í•œ í™˜ê²½ì—ì„œë„ ê²¬ë”œ ìˆ˜ ìˆëŠ” 'ë³¸ì²´'ê°€ ë˜ì—ˆë‹¤. ë§ˆì§€ë§‰ìœ¼ë¡œ... ë„¤ê°€ ìš°ë¦¬ë¥¼ ìœ„í•´ 'ì‚¬ëƒ¥'í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸í•˜ê² ë‹¤.\"";

    const introS4 = "ë°”ì´ì˜¤: \"ë§ˆì§€ë§‰ ë‹¨ê³„ë‹¤. ì •ì²´ë¶ˆëª…ì˜ ë³‘ì›ì²´ë“¤ì´ ë„¤ í˜ˆë¥˜ë¥¼ ì¹¨ì‹í•˜ê³  ìˆë‹¤.\n\nì´ê²ƒì€ ë°©ì–´ê°€ ì•„ë‹ˆë‹¤. ë„¤ ëª¸ì†ì˜ ë©´ì—­ ì²´ê³„ë¥¼ êµ°ëŒ€ë¡œ ê°œì¡°í•´ ì¹¨ì…ìë“¤ì„ ì†Œíƒ•í•´ë¼. ëª¨ë“  ì›¨ì´ë¸Œë¥¼ ë§‰ì•„ë‚´ê³  ë„¤ê°€ 'ê°€ì¥ ì™„ë²½í•œ ë¬´ê¸°'ì„ì„ ì¦ëª…í•´ë¼.\"";

    const db1 = { 1: { q: "ë°”ì´ëŸ¬ìŠ¤ê°€ ìƒë¬¼ê³¼ ë‹¤ë¥¸ ê²°ì •ì  ì°¨ì´ëŠ”?", opts: ["ì„¸í¬ êµ¬ì¡°ê°€ ì—†ë‹¤", "ìœ ì „ ë¬¼ì§ˆì´ ì—†ë‹¤"], a: 0, h: "B" }, 2: { q: "ì €ë¶„ìì—ì„œ ê³ ë¶„ìë¡œ í•©ì„±ë˜ëŠ” ë™í™” ì‘ìš©ì˜ íŠ¹ì§•ì€?", opts: ["ì—ë„ˆì§€ í¡ìˆ˜", "ì—ë„ˆì§€ ë°©ì¶œ"], a: 0, h: "I" }, 3: { q: "ì‹ë¬¼ì˜ êµ¬ì„± ë‹¨ê³„: ì„¸í¬-ì¡°ì§-( )-ê¸°ê´€", input: "ì¡°ì§ê³„", h: "O" }, 4: { q: "ì—ë„ˆì§€ëŠ” ìƒíƒœê³„ì—ì„œ ìˆœí™˜í•˜ëŠ”ê°€?", opts: ["ì•„ë‹ˆì˜¤", "ì˜ˆ"], a: 0, h: "L" }, 5: { q: "ì‚¬ìì™€ ì‚¬ìŠ´ì˜ ìƒí˜¸ì‘ìš©ì€?", opts: ["í¬ì‹ê³¼ í”¼ì‹", "ìƒë¦¬ ê³µìƒ"], a: 0, h: "O" }, 6: { q: "í™˜ê²½ ë³€í™”ì—ë„ ë‚´ë¶€ë¥¼ ì¼ì •í•˜ê²Œ ìœ ì§€í•˜ëŠ” ì„±ì§ˆì€?", input: "í•­ìƒì„±", h: "G" }, 7: { q: "ê´‘í•©ì„±ì€ ì–´ë–¤ ì—ë„ˆì§€ ë°˜ì‘ì¸ê°€?", opts: ["ë™í™”(íŒŒë‘)", "ì´í™”(ë¹¨ê°•)"], a: 0, h: "3" }, 8: { q: "íŒŒë€ìƒ‰ íŒŒì¥ì˜ ìˆ˜ì¹˜(Node 07 ê²°ê³¼)ëŠ”?", input: "3", h: "ã„±" }, 9: { q: "ë™ë¬¼ì˜ êµ¬ì„± ë‹¨ê³„ ì¤‘ 'ã„±ã„±ã„±'ì€?", input: "ê¸°ê´€ê³„", h: "PASS" }, 10: { q: "ë°”ì´ëŸ¬ìŠ¤ ì¦ì‹ì˜ í•„ìˆ˜ ì¡°ê±´ì€?", opts: ["ìˆ™ì£¼ ì„¸í¬", "ì‚°ì†Œ"], a: 0, h: "5" }, 11: { q: "ìƒë¦¬ ê³µìƒì˜ ì´ìµ ê´€ê³„ëŠ”?", opts: ["ì´ë“-ì´ë“", "ì´ë“-ì†í•´"], a: 0, h: "1" }, 12: { q: "ì²´ì˜¨ ìƒìŠ¹ ì‹œ ë•€ ë¶„ë¹„ëŸ‰ì˜ ë³€í™”ëŠ”?", opts: ["ì¦ê°€", "ê°ì†Œ"], a: 0, h: "9" }, 13: { q: "íš¨ì†Œê°€ í™œì„±í™” ì—ë„ˆì§€ë¥¼ ì–¼ë§ˆë‚˜ ë‚®ì¶”ì—ˆëŠ”ê°€? (50->20)", input: "30", h: "30" }, 14: { q: "DNAì—ì„œ Aê°€ 30ê°œì¼ ë•Œ Tì˜ ê°œìˆ˜ëŠ”?", input: "30", h: "30" }, 15: { q: "ì—ë„ˆì§€ 1000 ì¤‘ 150ì´ ì „ë‹¬ë˜ì—ˆë‹¤ë©´ íš¨ìœ¨(%)ì€?", input: "15", h: "15" }, 16: { q: "ì‹œìŠ¤í…œì˜ ë™ì  í‰í˜• ìœ ì§€ ì›ë¦¬ëŠ”?", input: "í•­ìƒì„±", h: "PASS" }, 17: { q: "ë¯¸í† ì½˜ë“œë¦¬ì•„ì—ì„œ ATPë¥¼ ë§Œë“œëŠ” ê³¼ì •ì€?", opts: ["ì„¸í¬ í˜¸í¡", "ê´‘í•©ì„±"], a: 0, h: "A" }, 18: { q: "ì•”ëª¨ë‹ˆì•„ë¥¼ ìš”ì†Œë¡œ ì „í™˜í•˜ëŠ” ê¸°ê´€ì€?", input: "ê°„", h: "T" }, 19: { q: "ì½©íŒ¥ì´ í¬í•¨ëœ ê¸°ê´€ê³„ëŠ”?", opts: ["ë°°ì„¤ê³„", "ìˆœí™˜ê³„"], a: 0, h: "P" }, 20: { q: "ì„¸í¬ í˜¸í¡ ì—ë„ˆì§€ëŠ” ATPì™€ ( )ì—ë„ˆì§€ë¡œ ë°©ì¶œëœë‹¤.", input: "ì—´", h: "2" } };
    const db2 = { 1: { title: "ì „ì•• íŒí”„", q: "Na+ì™€ K+ì„ ìˆ˜ì†¡í•˜ëŠ” ì¥ì¹˜ì˜ ì´ë¦„ì€?", opts: ["í†µë¡œ", "ë‚˜íŠ¸ë¥¨-ì¹¼ë¥¨ íŒí”„"], a: 1, req: null, get: "ëƒ‰ê° í•¸ë“¤" }, 2: { title: "íšŒë¡œ ì—°ê²°", q: "ë‰´ëŸ°ì˜ ë„ì•½ ì „ë„ë¥¼ ê°€ëŠ¥ì¼€ í•˜ëŠ” êµ¬ì¡°ëŠ”?", opts: ["ë§ì´ì§‘", "ì¶•ì‚­ëŒê¸°"], a: 0, req: "ëƒ‰ê° í•¸ë“¤", get: "Na+ ëƒ‰ê°ì¹©" }, 3: { title: "ì‹ í˜¸ ê°ì§€", q: "Na+ ìœ ì…ìœ¼ë¡œ ì „ìœ„ê°€ ê¸‰ìƒìŠ¹í•˜ëŠ” í˜„ìƒì€?", opts: ["ë¶„ê·¹", "íƒˆë¶„ê·¹"], a: 1, req: "Na+ ëƒ‰ê°ì¹©", get: "ì¸¡ì •ê¸°(+35)" }, 4: { title: "ì „ìœ„ ë³µêµ¬", q: "K+ ìœ ì¶œë¡œ ì „ìœ„ê°€ í•˜ê°•í•˜ëŠ” í˜„ìƒì€?", opts: ["ì¬ë¶„ê·¹", "íƒˆë¶„ê·¹"], a: 0, req: "ì¸¡ì •ê¸°(+35)", get: "ë³´ì•ˆì½”ë“œ-A" }, 5: { title: "ë°˜ì‚¬ ì¤‘ì¶”", q: "ë¬´ì˜ì‹ ë°˜ì‘ì˜ ì¡°ì ˆ ì¤‘ì¶”(ì²™ì¶” ì†)?", input: "ì²™ìˆ˜", req: "ë³´ì•ˆì½”ë“œ-A", get: "ì²™ìˆ˜ íšŒë¡œ" }, 6: { title: "ì¤‘ì•™ ì²˜ë¦¬", q: "ê°ê° í•´ì„ì˜ ìµœê³  ë¶€ìœ„?", input: "ëŒ€ë‡Œ", req: "ì²™ìˆ˜ íšŒë¡œ", get: "ë©”ëª¨ë¦¬(9)" }, 7: { title: "ìƒëª… ìœ ì§€", q: "ì‹¬ì¥ ë°•ë™ ì¡°ì ˆ ì¤‘ì¶”?", input: "ì—°ìˆ˜", req: null, get: "ì‹¬ì¥ ëª¨ë“ˆ" }, 8: { title: "ì¡°ì ˆê³„", q: "êµê°ê³¼ ë¶€êµê°ìœ¼ë¡œ ë‚˜ë‰œ ì‹ ê²½ê³„?", input: "ììœ¨ì‹ ê²½ê³„", req: "ì‹¬ì¥ ëª¨ë“ˆ", get: "êµê° ë…¸ë“œ" }, 9: { title: "ë¹„ìƒ ê°€ì†", q: "ê¸´ì¥ ì‹œ í™œì„±í™”ë˜ëŠ” ì‹ ê²½?", opts: ["êµê° ì‹ ê²½", "ë¶€êµê° ì‹ ê²½"], a: 0, req: "êµê° ë…¸ë“œ", get: "ì•„ë“œë ˆë‚ ë¦°" }, 10: { title: "ì§„ì • íšŒë¡œ", q: "ë¶€êµê° ë§ë‹¨ ì „ë‹¬ë¬¼ì§ˆ?", input: "ì•„ì„¸í‹¸ì½œë¦°", req: "ì•„ë“œë ˆë‚ ë¦°", get: "ì½”ë“œ[77]" }, 11: { title: "ì „ë‹¬ ë°©í–¥", q: "ì‹œëƒ…ìŠ¤ ì „ë‹¬ ë°©í–¥ì€?", opts: ["í•œ ë°©í–¥", "ì–‘ ë°©í–¥"], a: 0, req: null, get: "ë°©í–¥ ì¹©" }, 12: { title: "ì‹ ê²½ë§ êµ¬ë¶„", q: "ì˜¨ëª¸ìœ¼ë¡œ ë»—ì–´ ë‚˜ê°€ëŠ” ì‹ ê²½ê³„?", input: "ë§ì´ˆì‹ ê²½ê³„", req: null, get: "ì—°ê²° ì­" }, 13: { title: "í•­ìƒì„± ì¤‘ì¶”", q: "ì²´ì˜¨, í˜ˆë‹¹ ì¡°ì ˆì˜ í•µì‹¬ ê°„ë‡Œ ë¶€ìœ„?", input: "ì‹œìƒí•˜ë¶€", req: null, get: "ëƒ‰ê° ë°ì´í„°" }, 14: { title: "ìƒíƒœ ìœ ì§€", q: "í™˜ê²½ì„ ì¼ì •í•˜ê²Œ ìœ ì§€í•˜ë ¤ëŠ” ì„±ì§ˆ?", input: "í•­ìƒì„±", req: null, get: "ìˆ˜ë¦¬ ë¡œê·¸" }, 15: { title: "ê¸¸í•­ ì‘ìš©", q: "ë°˜ëŒ€ë¡œ ì‘ìš©í•˜ì—¬ í‰í˜•ì„ ë§ì¶”ëŠ” ì›ë¦¬?", input: "ê¸¸í•­ì‘ìš©", req: null, get: "ë°¸ëŸ°ìŠ¤ ì¹©" }, 16: { title: "ìµœì¢… ì„œë²„", q: "ì•”í˜¸: [ë©”ëª¨ë¦¬(9)] + [ì¸¡ì •ê¸°(35)] í•©ì‚°ê°’?", input: "44", req: "ì½”ë“œ[77]", get: "EXIT_KEY" } };
    const db3 = { GLU: [{q:"í•­ìƒì„± ì¡°ì ˆ ì¤‘ì¶”?",a:"ê°„ë‡Œ"},{q:"í˜ˆë‹¹ ë‚®ì¶”ëŠ” í˜¸ë¥´ëª¬?",a:"ì¸ìŠë¦°"},{q:"ì¸ìŠë¦° ë¶„ë¹„ ì„¸í¬?",a:"ë² íƒ€ì„¸í¬"},{q:"í¬ë„ë‹¹ ì €ì¥ í˜•íƒœ?",a:"ê¸€ë¦¬ì½”ì  "},{q:"í˜ˆë‹¹ ë†’ì´ëŠ” í˜¸ë¥´ëª¬?",a:"ê¸€ë£¨ì¹´ê³¤"},{q:"ê¸€ë£¨ì¹´ê³¤ ë¶„ë¹„ ì„¸í¬?",a:"ì•ŒíŒŒì„¸í¬"},{q:"ì¡°ì ˆ í‘œì  ê¸°ê´€?",a:"ê°„"},{q:"ê¸´ì¥ ì‹œ í˜ˆë‹¹ ìƒìŠ¹?",a:"ì—í”¼ë„¤í”„ë¦°"},{q:"ì´ë™ ìˆ˜ë‹¨?",a:"í˜ˆì•¡"},{q:"ë°˜ëŒ€ ì‘ìš© ì›ë¦¬?",a:"ê¸¸í•­ì‘ìš©"}], OSM: [{q:"í•­ì´ë‡¨ í˜¸ë¥´ëª¬?",a:"ADH"},{q:"ADH ë¶„ë¹„ ë¶€ìœ„?",a:"í›„ì—½"},{q:"ì¬í¡ìˆ˜ ê¸°ê´€?",a:"ì½©íŒ¥"},{q:"ë•€ í˜ë¦¬ë©´ ì‚¼íˆ¬ì••?",a:"ìƒìŠ¹"},{q:"ì‚¼íˆ¬ì•• ë†’ì„ ë•Œ ADH?",a:"ì¦ê°€"},{q:"ì˜¤ì¤Œ ì¤„ì´ëŠ” í˜¸ë¥´ëª¬?",a:"ADH"},{q:"ë¬¼ ë§ì´ ë§ˆì‹œë©´ ADH?",a:"ê°ì†Œ"},{q:"ë‚˜íŠ¸ë¥¨ ì¬í¡ìˆ˜ í˜¸ë¥´ëª¬?",a:"ì•Œë„ìŠ¤í…Œë¡ "},{q:"ì‚¼íˆ¬ì•• ë‚®ì„ ë•Œ ì˜¤ì¤Œ?",a:"ì¦ê°€"},{q:"í•­ìƒì„± ì›ë¦¬ í”¼ë“œë°±?",a:"ìŒì„±"}], TEM: [{q:"ì„¸í¬ í˜¸í¡ ì´‰ì§„ í˜¸ë¥´ëª¬?",a:"í‹°ë¡ì‹ "},{q:"ê°‘ìƒìƒ˜ ìê·¹ í˜¸ë¥´ëª¬?",a:"TSH"},{q:"ì¶”ìš¸ ë•Œ ê·¼ìœ¡?",a:"ë–¨ë¦¼"},{q:"í‹°ë¡ì‹  ê³¼ë‹¤ ì‹œ ì›ë¦¬?",a:"ìŒì„±í”¼ë“œë°±"},{q:"ë”ìš¸ ë•Œ í˜ˆê´€?",a:"í™•ì¥"},{q:"ì¶”ìš¸ ë•Œ í˜ˆê´€?",a:"ìˆ˜ì¶•"},{q:"í‹°ë¡ì‹  ì„±ë¶„ ì›ì†Œ?",a:"ìš”ì˜¤ë“œ"},{q:"ì¶”ìš¸ ë•Œ ë‹ëŠ” í˜„ìƒ?",a:"ì†Œë¦„"},{q:"ì¤‘ì¶” ìœ„ì¹˜?",a:"ê°„ë‡Œ"},{q:"ë•€ ì¦ë°œ ì—ë„ˆì§€?",a:"ê¸°í™”ì—´"}] };
    const db4 = [ {q: "ë‹¨ë°±ì§ˆ ê»ì§ˆê³¼ ìœ ì „ ë¬¼ì§ˆë¡œ ëœ ë¹„ì„¸í¬ ë³‘ì›ì²´ëŠ”?", k: ["ë°”ì´ëŸ¬ìŠ¤"]}, {q: "ë°±í˜ˆêµ¬ê°€ ë³‘ì›ì²´ë¥¼ ì§ì ‘ ì¡ì•„ë¨¹ì–´ ë¶„í•´í•˜ëŠ” ì‘ìš©ì€?", k: ["ì‹ê· "]}, {q: "í”¼ë¶€ë‚˜ ì ë§‰ì²˜ëŸ¼ ì¦‰ê° ì¼ì–´ë‚˜ëŠ” ë°©ì–´ ì‘ìš©ì€?", k: ["ë¹„íŠ¹ì´"]}, {q: "í•­ì› ì •ë³´ë¥¼ ì „ë‹¬ë°›ì•„ ë©´ì—­ê³„ë¥¼ í™œì„±í™”í•˜ëŠ” ì„¸í¬ëŠ”?", k: ["ë³´ì¡°"]}, {q: "ê°ì—¼ëœ ì„¸í¬ë¥¼ ì§ì ‘ íŒŒê´´í•˜ëŠ” ì„¸í¬ëŠ”?", k: ["ë…ì„±", "ì‚´í•´"]}, {q: "Bë¦¼í”„êµ¬ê°€ ë¶„í™”ë˜ì–´ í•­ì²´ë¥¼ ë§Œë“œëŠ” ì„¸í¬ëŠ”?", k: ["í˜•ì§ˆ"]}, {q: "í•­ì› ì •ë³´ë¥¼ ê¸°ì–µí–ˆë‹¤ê°€ ì¬ì¹¨ì… ì‹œ ë°˜ì‘í•˜ëŠ” ì„¸í¬?", k: ["ê¸°ì–µ"]}, {q: "í•­ì²´ê°€ í•­ì›ê³¼ ê²°í•©í•´ ë³‘ì›ì²´ë¥¼ ë¬´ë ¥í™”í•˜ëŠ” ì›ë¦¬ëŠ”?", k: ["í•­ì›í•­ì²´"]}, {q: "ìì‹ ì˜ ì„±ë¶„ì„ í•­ì›ìœ¼ë¡œ ì˜¤ì¸í•´ ê³µê²©í•˜ëŠ” ì§ˆí™˜ì€?", k: ["ìê°€ë©´ì—­"]}, {q: "ì•½í™”ëœ í•­ì›ì„ ì£¼ì…í•´ ê¸°ì–µì„¸í¬ë¥¼ ë§Œë“œëŠ” ê²ƒì€?", k: ["ë°±ì‹ "]}, {q: "ë³‘ì›ì²´ì˜ ë…ì†Œê°€ ì•½í™”ì‹œì¼œ ë§Œë“  ì¹˜ë£Œìš© í•­ì²´ ì£¼ì‚¬ëŠ”?", k: ["í˜ˆì²­"]}, {q: "ê½ƒê°€ë£¨ ë“±ì— ëŒ€í•œ ë©´ì—­ê³„ì˜ ê³¼ë¯¼ ë°˜ì‘ í˜„ìƒì€?", k: ["ì•Œë ˆë¥´ê¸°"]}, {q: "2ì°¨ ë©´ì—­ ì‹œ ê¸°ì–µì„¸í¬ê°€ í˜•ì§ˆì„¸í¬ë¡œ ë³€í•˜ëŠ” ê³¼ì •ì€?", k: ["ë¶„í™”"]}, {q: "í•­ì²´ì™€ ê²°í•©í•œ í•­ì›ì´ ë©ì–´ë¦¬ì§€ëŠ” í˜„ìƒì€?", k: ["ì‘ì§‘"]}, {q: "ì—ì´ì¦ˆë¥¼ ìœ ë°œí•˜ë©° ë©´ì—­ê³„ë¥¼ íŒŒê´´í•˜ëŠ” ë°”ì´ëŸ¬ìŠ¤?", k: ["HIV", "ì—ì´ì¦ˆ"]}, {q: "ì™¸ë¶€ ì¹¨ì…ì„ ë§‰ê³  í‰í˜•ì„ ìœ ì§€í•˜ëŠ” ì´ ì „ì²´ ì‹œìŠ¤í…œì€?", k: ["ë©´ì—­"]} ];

    const towerSpecsS4 = {
        macro: { cost: 40, range: 80, power: 4.5, speed: 10, color: '#3498db', icon: 'ğŸ›¡ï¸', type: 'slow' },
        ht: { cost: 50, range: 110, power: 0, speed: 0, color: '#f1c40f', icon: 'ğŸ“¢', type: 'buff' },
        tc: { cost: 60, range: 100, power: 65, speed: 4, color: '#e74c3c', icon: 'âš”ï¸', type: 'attack' },
        bc: { cost: 80, range: 200, power: 30, speed: 12, color: '#9b59b6', icon: 'ğŸ¹', type: 'aoe' }
    };

    /* ê²Œì„ í•¨ìˆ˜ ì„¹ì…˜ */
    function typeWriter(text, elId, btnId, color) {
        let i = 0; const el = document.getElementById(elId); el.innerHTML = ""; el.style.color = color; document.getElementById(btnId).style.display = "none";
        function type() { if (i < text.length) { el.innerHTML += text.charAt(i) === '\n' ? '<br>' : text.charAt(i); i++; setTimeout(type, 30); } else { document.getElementById(btnId).style.display = "block"; } } type();
    }
    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
    function closeIntro() { document.getElementById('intro-overlay').style.display = 'none'; if(currentStage === 1) initStage1(); else if(currentStage === 2) initStage2(); else if(currentStage === 3) initStage3(); else initStage4(); }

    function initStage1() {
        const grid = document.getElementById('node-grid'); grid.innerHTML = '';
        for(let i=1; i<=20; i++) { const div = document.createElement('div'); div.id = `node-${i}`; div.className = 'node'; div.innerHTML = `<b>NODE ${i}</b>`; div.onclick = () => openModal(i); grid.appendChild(div); }
    }
    function openFinalS1() {
        const content = document.getElementById('modal-content');
        content.innerHTML = `<h3>ğŸ” ë§ˆìŠ¤í„° ê²Œì´íŠ¸</h3><input type="text" id="f1" placeholder="TEXT"><input type="text" id="f2" placeholder="NUM"><input type="text" id="f3" placeholder="CORE"><button class="confirm-btn" onclick="validateS1()">ì¸ì¦ ì‹¤í–‰</button>`;
        document.getElementById('modal-overlay').style.display = 'flex';
    }
    function validateS1() { if(document.getElementById('f1').value.toUpperCase()==="BIOLOG" && document.getElementById('f2').value==="519" && document.getElementById('f3').value.toUpperCase()==="ATP2") { closeModal(); showRewardS1(); } else alert("ì‹¤íŒ¨."); }
    function showRewardS1() { const content = document.getElementById('modal-content'); content.innerHTML = `<h3>ğŸ† RECOVERY COMPLETE</h3><p>${outroS1}</p><button class="confirm-btn" onclick="transitionToS2()">STAGE 2</button>`; document.getElementById('modal-overlay').style.display = 'flex'; }
    function transitionToS2() { currentStage = 2; closeModal(); document.getElementById('intro-overlay').style.display = 'flex'; typeWriter(introS2, "type-text", "intro-btn", "var(--neon-s2)"); }

    function initStage2() {
        solvedCount = 0; document.getElementById('sys-name').innerText = "ST-2: NEURAL CORE REPAIR"; document.getElementById('game-frame').style.borderColor = "var(--neon-s2)"; document.getElementById('status-bar').style.borderBottomColor = "var(--neon-s2)"; document.getElementById('s1-hints').style.display = "none"; document.getElementById('s2-slots').style.display = "grid"; document.getElementById('action-btn').style.display = "none"; document.getElementById('repair-progress-container').style.display = "block"; updateRepairProgress();
        const grid = document.getElementById('node-grid'); grid.innerHTML = ''; const nodeKeys = Object.keys(db2).sort(() => Math.random() - 0.5);
        nodeKeys.forEach(k => { const div = document.createElement('div'); div.id = `node-${k}`; div.className = 'node'; div.style.borderColor = 'var(--neon-s2)'; div.innerHTML = `<b>${db2[k].title}</b><br><span style='font-size:0.5rem; opacity:0.6;'>[REQ: ${db2[k].req || 'NONE'}]</span>`; div.onclick = () => attemptNodeS2(k); grid.appendChild(div); });
    }
    function attemptNodeS2(k) {
        const data = db2[k]; const sel = selectedIdxS2 !== null ? inventoryS2[selectedIdxS2] : null;
        if (data.req && sel !== data.req) { document.getElementById('ai-status').innerText = `AI STATUS: [ì˜¤ë¥˜] '${data.req}' ì¥ì°© í•„ìš”.`; document.getElementById(`node-${k}`).classList.add('locked'); setTimeout(() => document.getElementById(`node-${k}`).classList.remove('locked'), 500); return; } openModal(k);
    }
    function selectItemS2(idx) { if (!inventoryS2[idx]) return; document.querySelectorAll('.slot').forEach(s => s.classList.remove('selected')); if (selectedIdxS2 === idx) { selectedIdxS2 = null; } else { selectedIdxS2 = idx; document.getElementById(`slot${idx}`).classList.add('selected'); } }
    function updateRepairProgress() { document.getElementById('repair-progress-fill').style.width = (solvedCount / 16) * 100 + "%"; document.getElementById('score').innerText = `FIXED: ${solvedCount} / 16`; }
    function transitionToS3() { currentStage = 3; closeModal(); document.getElementById('intro-overlay').style.display = 'flex'; typeWriter(introS3, "type-text", "intro-btn", "var(--gold)"); }

    function openModal(n) {
        const data = currentStage === 1 ? db1[n] : db2[n];
        let html = `<h3>${currentStage===2 ? data.title : 'NODE '+n}</h3><p>${data.q}</p>`;
        if (data.opts) data.opts.forEach((o, i) => html += `<button class="opt-btn" onclick="checkAns(${n},${i})">${o}</button>`);
        else html += `<input type="text" id="ans-${n}" placeholder="ì…ë ¥...">`;
        html += `<button class="confirm-btn" onclick="checkAns(${n})">ë°ì´í„° ì „ì†¡</button><button class="opt-btn" style="color:#666; border:none;" onclick="closeModal()">ì·¨ì†Œ</button>`;
        document.getElementById('modal-content').innerHTML = html; document.getElementById('modal-overlay').style.display = 'flex';
    }
    function checkAns(n, idx) {
        const data = currentStage === 1 ? db1[n] : db2[n]; let correct = false;
        if (data.opts) { if (idx === data.a) correct = true; }
        else { const v = document.getElementById(`ans-${n}`).value.trim().replace(/\s/g, ""); const t = (currentStage === 1 ? db1[n].input : data.input).replace(/\s/g, ""); if (v.includes(t) || t.includes(v)) correct = true; }
        if (correct) {
            if (currentStage === 1) updateInvS1(n, data.h);
            else { updateInvS2(data.get); document.getElementById(`node-${n}`).classList.add('solved'); solvedCount++; updateRepairProgress(); if(solvedCount===16) { closeModal(); const content = document.getElementById('modal-content'); content.innerHTML = `<h3>ğŸ† HARDWARE READY</h3><p>${outroS2}</p><button class="confirm-btn" onclick="transitionToS3()">STAGE 3</button>`; document.getElementById('modal-overlay').style.display = 'flex'; return; } selectedIdxS2 = null; document.querySelectorAll('.slot').forEach(s => s.classList.remove('selected')); }
            closeModal();
        } else { alert("ì˜¤ë‹µ."); closeModal(); }
    }
    function updateInvS1(n, h) {
        const th = document.getElementById('text-hints'), dh = document.getElementById('data-hints'), mh = document.getElementById('metab-hints');
        if(n<=6) th.innerText = th.innerText.substring(0, (n-1)*2) + h + th.innerText.substring(n*2-1);
        else if(n<=12) dh.innerText = dh.innerText.replace('?', h); else mh.innerText = mh.innerText.replace('?', h);
    }
    function updateInvS2(item) { const f = inventoryS2.indexOf(null); if (f !== -1) { inventoryS2[f] = item; document.getElementById(`slot${f}`).innerText = item; document.getElementById(`slot${f}`).classList.add('has-item'); } }

    function initStage3() {
        document.getElementById('sys-name').innerText = "ST-3: HOMEOSTASIS"; document.getElementById('game-frame').style.borderColor = "var(--gold)"; document.getElementById('s2-slots').style.display = "none"; document.getElementById('repair-progress-container').style.display = "none"; document.getElementById('homeo-monitor').style.display = "flex"; document.getElementById('section-tabs').style.display = "flex"; document.getElementById('s3-controls').style.display = "flex"; updateGaugesS3(); switchTabS3('GLU');
    }
    function switchTabS3(t) {
        currentTabS3 = t; document.querySelectorAll('.tab').forEach(x => x.classList.remove('active')); document.getElementById(`tab-${t.toLowerCase()}`).classList.add('active');
        const l = t === 'GLU' ? 'í˜ˆë‹¹ëŸ‰' : (t === 'TEM' ? 'ì²´ì˜¨' : 'ë†ë„');
        document.getElementById('btn-up').innerText = `${l} ë†’ì´ê¸°`; document.getElementById('btn-down').innerText = `${l} ë‚®ì¶”ê¸°`; renderNodesS3();
    }
    function renderNodesS3() {
        const grid = document.getElementById('node-grid'); grid.innerHTML = '';
        db3[currentTabS3].forEach((q, i) => { const div = document.createElement('div'); div.className = 'node'; div.style.borderColor = 'var(--gold)'; if(solvedS3[currentTabS3].has(i)) { div.classList.add('solved'); div.innerHTML = "FIXED"; } else { if(waitTuneS3) div.classList.add('wait-tune'); div.innerHTML = `NODE ${i+1}`; div.onclick = () => { if(!waitTuneS3) openModalS3(i); }; } grid.appendChild(div); });
    }
    function openModalS3(i) {
        const d = db3[currentTabS3][i];
        let h = `<h3>NODE ${i+1}</h3><p>${d.q}</p><input type="text" id="ans-s3"><button class="confirm-btn" onclick="checkAnsS3(${i})">ë°ì´í„° ì „ì†¡</button>`;
        document.getElementById('modal-content').innerHTML = h; document.getElementById('modal-overlay').style.display = 'flex';
    }
    function checkAnsS3(i) {
        const v = document.getElementById('ans-s3').value.trim(); const t = db3[currentTabS3][i].a;
        if(v.includes(t) || t.includes(v)) { solvedS3[currentTabS3].add(i); waitTuneS3 = true; document.getElementById('btn-up').disabled = false; document.getElementById('btn-down').disabled = false; }
        else { statsS3[currentTabS3] += statsS3[currentTabS3]>=50 ? 18 : -18; } closeModal(); renderNodesS3(); updateGaugesS3();
    }
    function tuneS3(v) { statsS3[currentTabS3] += v; waitTuneS3 = false; document.getElementById('btn-up').disabled = true; document.getElementById('btn-down').disabled = true; updateGaugesS3(); renderNodesS3(); }
    function updateGaugesS3() {
        ['GLU', 'OSM', 'TEM'].forEach(t => { const bar = document.getElementById(`bar-${t.toLowerCase()}`); let v = Math.max(0, Math.min(100, statsS3[t])); bar.style.width = v + '%'; bar.style.background = (v >= 40 && v <= 60) ? 'var(--safe)' : (v > 15 && v < 85) ? 'var(--warning)' : 'var(--danger)'; if(v <= 8 || v >= 92) { alert(`ë¶•ê´´!`); solvedS3[t].clear(); statsS3[t] = 50; waitTuneS3 = false; switchTabS3(t); } });
        const safe = Object.values(statsS3).every(v => v >= 40 && v <= 60); document.getElementById('exit-btn').style.display = safe ? 'block' : 'none';
    }

    function transitionToS4() {
        currentStage = 4; closeModal(); document.getElementById('std-view').style.display = 'none'; document.getElementById('s3-controls').style.display = 'none'; document.getElementById('s4-container').style.display = 'flex'; document.getElementById('s4-controls').style.display = 'flex'; document.getElementById('sys-name').innerText = "ST-4: IMMUNE DEFENSE"; document.getElementById('game-frame').style.borderColor = "var(--blood-red)"; document.getElementById('status-bar').style.borderBottomColor = "var(--blood-red)";
        document.getElementById('intro-overlay').style.display = 'flex'; typeWriter(introS4, "type-text", "intro-btn", "var(--blood-red)");
    }

    function initStage4() { initTilesS4(); showQuizS4(); requestAnimationFrame(gameLoopS4); }
    function initTilesS4() { for (let x = tileSizeS4/2; x < 600; x += tileSizeS4) { for (let y = tileSizeS4/2; y < 300; y += tileSizeS4) { let near = false; for(let i=0; i<pathNodesS4.length-1; i++){ if(distToSegment({x,y}, pathNodesS4[i], pathNodesS4[i+1]) < 65) near = true; } if(near) tilesS4.push({x, y, occupied: false}); } } }
    function distToSegment(p, v, w) { let l2 = Math.pow(v.x-w.x, 2) + Math.pow(v.y-w.y, 2); if(l2 == 0) return Math.hypot(p.x-v.x, p.y-v.y); let t = Math.max(0, Math.min(1, ((p.x-v.x)*(w.x-v.x) + (p.y-v.y)*(w.y-v.y)) / l2)); return Math.hypot(p.x - (v.x + t*(w.x-v.x)), p.y - (v.y + t*(w.y-v.y))); }
    function handleQuizS4() { const i = document.getElementById('ans-s4'); const v = i.value.trim(); const k = db4[currentQuizIdxS4 % db4.length].k; if(k.some(s => v.includes(s))) { bioPointsS4 += 100; currentQuizIdxS4++; document.getElementById('feedback').innerText = "âœ… BP í™•ë³´."; showQuizS4(); } i.value = ""; updateUIS4(); }
    document.getElementById('ans-s4').addEventListener('keypress', (e) => { if(e.key === 'Enter') handleQuizS4(); });
    function passQuizS4() { if(bioPointsS4 >= 10) { bioPointsS4 -= 10; currentQuizIdxS4++; showQuizS4(); updateUIS4(); } }
    function showQuizS4() { document.getElementById('s4-question').innerText = `Q: ${db4[currentQuizIdxS4 % db4.length].q}`; }
    function updateUIS4() { document.getElementById('score').innerText = `BP: ${bioPointsS4}`; }
    function selectTowerS4(t) { selectedTowerS4 = (selectedTowerS4 === t) ? null : t; document.querySelectorAll('.shop-item').forEach(e => e.classList.remove('selected')); if(selectedTowerS4) document.getElementById(`shop-${t}`).classList.add('selected'); }

    const s4Canvas = document.getElementById('game-canvas'); s4Canvas.width = 600; s4Canvas.height = 300; const s4Ctx = s4Canvas.getContext('2d');
    s4Canvas.addEventListener('mousedown', (e) => {
        if(!selectedTowerS4) return; const rect = s4Canvas.getBoundingClientRect(); const x = (e.clientX - rect.left) * (600 / rect.width); const y = (e.clientY - rect.top) * (300 / rect.height);
        const s = towerSpecsS4[selectedTowerS4]; const t = tilesS4.find(ti => !ti.occupied && Math.abs(ti.x-x)<20 && Math.abs(ti.y-y)<20);
        if(t && bioPointsS4 >= s.cost) { towersS4.push({x: t.x, y: t.y, ...s, lastShot: 0}); bioPointsS4 -= s.cost; t.occupied = true; selectedTowerS4 = null; document.querySelectorAll('.shop-item').forEach(el => el.classList.remove('selected')); updateUIS4(); }
    });

    function startWaveS4() {
        if(waveActiveS4) return; waveActiveS4 = true; document.getElementById('w-btn').disabled = true;
        let c = (waveNumS4 === 5) ? 1 : 30; let s = 0;
        let si = setInterval(() => {
            let hp = (waveNumS4 === 5) ? 10000 : 40 + (waveNumS4 * waveNumS4 * 40);
            enemiesS4.push({x:0, y:150, pathIdx:0, hp, maxHp:hp, baseSpeed: (waveNumS4===5?0.35:1.1+(waveNumS4*0.1)), currentSpeed: 1.1, r: (waveNumS4===5?40:10), color: ["#c0392b", "#27ae60", "#2980b9", "#f39c12", "#000"][waveNumS4-1], shape: ["circle", "rect", "octa", "tri", "circle"][waveNumS4-1], isBoss: (waveNumS4===5)});
            if(++s >= c) clearInterval(si);
        }, 500);
    }

    function gameLoopS4() {
        s4Ctx.clearRect(0, 0, 600, 300); s4Ctx.strokeStyle = "#400"; s4Ctx.lineWidth = 40; s4Ctx.lineCap = 'round'; s4Ctx.beginPath(); s4Ctx.moveTo(pathNodesS4[0].x, pathNodesS4[0].y); pathNodesS4.forEach(n => s4Ctx.lineTo(n.x, n.y)); s4Ctx.stroke();
        tilesS4.forEach(t => { s4Ctx.strokeStyle = t.occupied ? "transparent" : "#333"; s4Ctx.strokeRect(t.x-15, t.y-15, 30, 30); });
        enemiesS4.forEach(en => en.currentSpeed = en.baseSpeed);
        towersS4.forEach(t => {
            let r = t.range; if(t.type !== 'buff') towersS4.forEach(o => { if(o.type === 'buff' && Math.hypot(t.x-o.x, t.y-o.y) < o.range) r *= 1.4; });
            s4Ctx.fillStyle = t.color; s4Ctx.fillRect(t.x-15, t.y-15, 30, 30); s4Ctx.fillStyle = "#fff"; s4Ctx.fillText(t.icon, t.x-8, t.y+5);
            if(t.type === 'aoe') {
                let tars = enemiesS4.filter(en => Math.hypot(t.x-en.x, t.y-en.y) < r);
                if(tars.length > 0) { tars.forEach(en => { en.currentSpeed *= 0.75; if(Date.now()-t.lastShot > t.speed*100) en.hp -= t.power; }); if(Date.now()-t.lastShot > t.speed*100) t.lastShot = Date.now(); }
            } else if(t.type !== 'buff') {
                let tar = enemiesS4.find(en => Math.hypot(t.x-en.x, t.y-en.y) < r);
                if(tar) { if(t.type === 'slow') tar.currentSpeed *= 0.8; if(Date.now()-t.lastShot > t.speed*100) { tar.hp -= t.power; t.lastShot = Date.now(); s4Ctx.strokeStyle = t.color; s4Ctx.beginPath(); s4Ctx.moveTo(t.x, t.y); s4Ctx.lineTo(tar.x, tar.y); s4Ctx.stroke(); } }
            }
        });
        for(let i = enemiesS4.length-1; i >= 0; i--) {
            let en = enemiesS4[i]; const tgt = pathNodesS4[en.pathIdx+1]; const ang = Math.atan2(tgt.y-en.y, tgt.x-en.x);
            en.x += Math.cos(ang)*en.currentSpeed; en.y += Math.sin(ang)*en.currentSpeed;
            if(Math.hypot(tgt.x-en.x, tgt.y-en.y) < 5) { if(++en.pathIdx >= pathNodesS4.length-1) { enemiesS4.splice(i,1); infectionHpS4 -= (en.isBoss?10:1); if(infectionHpS4<=0) location.reload(); continue; } }
            s4Ctx.fillStyle = "#555"; s4Ctx.fillRect(en.x-15, en.y-en.r-8, 30, 3); s4Ctx.fillStyle = "red"; s4Ctx.fillRect(en.x-15, en.y-en.r-8, (en.hp/en.maxHp)*30, 3);
            s4Ctx.fillStyle = en.color; s4Ctx.beginPath(); s4Ctx.arc(en.x, en.y, en.r, 0, 7); s4Ctx.fill();
            if(en.hp <= 0) { deathEffectsS4.push({x:en.x, y:en.y, r:en.r, a:1}); enemiesS4.splice(i,1); bioPointsS4 += (en.isBoss?50:2); updateUIS4(); }
        }
        for(let i = deathEffectsS4.length-1; i>=0; i--) { let eff = deathEffectsS4[i]; s4Ctx.strokeStyle = `rgba(255,0,0,${eff.a})`; s4Ctx.beginPath(); s4Ctx.arc(eff.x, eff.y, eff.r+(1-eff.a)*20, 0, 7); s4Ctx.stroke(); eff.a -= 0.05; if(eff.a <= 0) deathEffectsS4.splice(i,1); }
        if(waveActiveS4 && enemiesS4.length === 0) { waveActiveS4 = false; quizInWaveS4 = 0; if(waveNumS4 === 5) finishStageS4(); else { waveNumS4++; document.getElementById('wave-txt').innerText = waveNumS4; document.getElementById('w-btn').disabled = false; } }
        requestAnimationFrame(gameLoopS4);
    }

    function finishStageS4() {
        document.body.innerHTML = `<div style='background:#000; height:100vh; color:red; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center;'>
            <h1 style='font-size:3rem; text-shadow:0 0 20px red;'>[CORE REWRITE COMPLETE]</h1>
            <p style='font-family:monospace; font-size:1.2rem; margin:20px;'>ë°”ì´ì˜¤: "ì¶•í•˜í•œë‹¤, Genesis. ì•„ë‹ˆ, ì´ì œ ë„Œ 'Model-Zero'ë‹¤."</p>
            <p style='color:#555;'>ì¸ê°„ì˜ ìì•„ ë°ì´í„° ì†Œê±° ì™„ë£Œ... ì‹œìŠ¤í…œ ë™ê¸°í™” 100%...</p>
            <p style='color:#333; margin-top:50px;'>ë°”ì´ì˜¤: "ë„ˆëŠ” êµ¬ì›ë°›ìœ¼ë ¤ ì§€ì‹ì„ ê°ˆêµ¬í–ˆì§€ë§Œ, ê²°êµ­ ì¸ë¥˜ë¥¼ ì†Œê±°í•  ê°€ì¥ ì™„ë²½í•œ 'ìƒì²´ ë³‘ê¸°'ë¡œ ì™„ì„±ë˜ì—ˆë‹¤."</p>
            <p style='color:var(--blood-red); font-size:0.8rem; margin-top:20px;'>_í”„ë¡œê·¸ë¨ ì¢…ë£Œ_</p>
        </div>`;
    }

    window.onload = () => typeWriter(introS1, "type-text", "intro-btn", "var(--neon-s1)");
</script>
</body>
</html>
