<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BIO-MASTER: TOTAL RECOVERY v8.4</title>
    <style>
        :root { 
            --neon-s1: #00ffcc; --neon-s2: #00d4ff; --gold: #ffcc00; 
            --blood-red: #ff4d4d; --bg: #050a10; --panel: #0d1624; 
            --danger: #ff4444; --safe: #00ff88; --warning: #ffaa00;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; display: flex; justify-content: center; min-height: 100vh; overflow-x: hidden; }
        
        #game-frame { width: 100%; max-width: 600px; background: var(--panel); position: relative; display: flex; flex-direction: column; border-left: 2px solid var(--neon-s1); border-right: 2px solid var(--neon-s1); min-height: 100vh; transition: border 0.5s; }
        
        #status-bar { background: rgba(0,255,204,0.1); padding: 10px 15px; display: flex; justify-content: space-between; border-bottom: 1px solid var(--neon-s1); position: sticky; top: 0; z-index: 2000; font-size: 0.8rem; backdrop-filter: blur(5px); }
        #homeo-monitor { display: none; background: #000; padding: 10px; border-bottom: 2px solid var(--gold); flex-direction: column; gap: 5px; position: sticky; top: 38px; z-index: 2000; }
        
        #repair-progress-container { display: none; width: 100%; height: 8px; background: #111; border-bottom: 1px solid var(--neon-s2); }
        #repair-progress-fill { width: 0%; height: 100%; background: var(--safe); transition: 0.5s; box-shadow: 0 0 10px var(--safe); }

        .node-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; padding-bottom: 300px; flex-grow: 1; overflow-y: auto; }
        .node { height: 85px; border: 1px solid var(--neon-s1); border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; background: rgba(0,255,204,0.02); font-size: 0.75rem; text-align: center; position: relative; transition: 0.3s; padding: 5px; }
        .node.solved { opacity: 0.15; pointer-events: none; filter: grayscale(1); }
        .node.locked { border-color: var(--danger); background: rgba(255, 68, 68, 0.15); color: var(--danger); animation: shake 0.3s; }
        .node.wait-tune { border-color: var(--warning); filter: sepia(1); cursor: not-allowed; opacity: 0.5; }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }

        #inventory-panel { position: fixed; bottom: 0; width: 100%; max-width: 600px; background: #000; border-top: 2px solid var(--gold); padding: 8px 15px; z-index: 900; height: 165px; display: flex; flex-direction: column; }
        .archive-box { border: 1px solid #333; padding: 5px; margin-bottom: 3px; border-radius: 4px; }
        .hint-text { color: var(--gold); font-family: monospace; font-size: 0.75rem; letter-spacing: 1px; }
        
        #s2-slots { display: none; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 5px; overflow-y: auto; flex-grow: 1; padding-bottom: 5px; }
        .slot { border: 1px solid #333; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 0.55rem; color: #555; border-radius: 4px; cursor: pointer; text-align: center; line-height: 1.1; min-height: 40px; }
        .slot.has-item { border-color: var(--gold); color: #fff; background: rgba(255,204,0,0.1); }
        .slot.selected { border-color: #fff; box-shadow: 0 0 10px #fff; background: rgba(255,255,255,0.2); color: #fff; }

        .gauge-container { display: flex; align-items: center; gap: 10px; }
        .label { width: 55px; color: var(--gold); font-size: 0.7rem; font-weight: bold; }
        .bar-bg { flex: 1; height: 12px; background: #222; border-radius: 6px; position: relative; overflow: hidden; border: 1px solid #444; }
        .bar-fill { height: 100%; width: 50%; background: var(--safe); transition: 0.4s; }
        
        #section-tabs { display: none; background: #000; border-bottom: 1px solid #333; }
        .tab { flex: 1; padding: 10px; text-align: center; font-size: 0.7rem; cursor: pointer; color: #555; transition: 0.3s; }
        .tab.active { color: var(--gold); background: rgba(255,204,0,0.1); font-weight: bold; border-bottom: 2px solid var(--gold); }

        #intro-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 5000; display: flex; flex-direction: column; padding: 30px; justify-content: center; }
        .story-text { font-family: 'Courier New', monospace; color: var(--neon-s1); line-height: 1.8; margin-bottom: 25px; border-left: 3px solid var(--neon-s1); padding-left: 15px; font-size: 0.9rem; white-space: pre-wrap; }
        .gate-btn { position: fixed; bottom: 175px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 540px; background: var(--danger); color: white; padding: 12px; border: none; border-radius: 10px; font-weight: bold; z-index: 1000; cursor: pointer; }
        
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 6000; justify-content: center; align-items: center; }
        .modal { background: #0d1117; border: 2px solid var(--neon-s1); padding: 20px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; }
        .opt-btn { width: 100%; padding: 12px; margin: 5px 0; background: #1c2128; border: 1px solid #333; color: #fff; border-radius: 8px; cursor: pointer; }
        input { width: 100%; padding: 12px; background: #000; border: 1px solid var(--neon-s1); color: #fff; border-radius: 8px; margin: 8px 0; text-align: center; font-size: 1.1rem; }
        
        .confirm-btn { width: 100%; padding: 18px; background: var(--neon-s1); color: #000; border: none; font-weight: 900; border-radius: 10px; cursor: pointer; font-size: 1.2rem; margin-top: 5px; box-shadow: 0 0 10px var(--neon-s1); }

        #s3-controls { display: none; gap: 8px; width: 100%; max-width: 400px; margin-top: 5px; }
        .act-btn { flex: 1; padding: 8px; border: 1px solid var(--gold); color: var(--gold); background: none; font-size: 0.75rem; cursor: pointer; border-radius: 5px; font-weight: bold; }
        .act-btn:disabled { border-color: #333; color: #444; opacity: 0.4; }
        #exit-btn { display: none; background: var(--safe); color: #000; width: 100%; max-width: 400px; padding: 10px; border: none; font-weight: bold; margin-top: 5px; cursor: pointer; border-radius: 5px; font-size: 0.8rem; }

        #s4-container { display: none; flex-direction: column; width: 100%; height: 100%; }
        #s4-canvas-container { position: relative; width: 100%; height: 280px; background: #fdf5f5; overflow: hidden; border-bottom: 2px solid var(--blood-red); touch-action: none; }
        #game-canvas { width: 100%; height: 100%; display: block; }
        #s4-shop { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; padding: 10px; background: #000; flex-grow: 1; overflow-y: auto; }
        .shop-item { background: #111; border: 1px solid #333; padding: 8px; border-radius: 6px; cursor: pointer; }
        .shop-item.selected { border-color: var(--blood-red); background: #2a0a0a; border-width: 2px; }
    </style>
</head>
<body>

<div id="game-frame">
    <div id="status-bar"><span id="sys-name">ST-1: BIOLOGICAL PROOF</span><span id="score">RECOVERY: 0 / 20</span></div>
    
    <div id="homeo-monitor">
        <div class="gauge-container"><div class="label">í˜ˆë‹¹ëŸ‰</div><div class="bar-bg"><div id="bar-glu" class="bar-fill"></div></div></div>
        <div class="gauge-container"><div class="label">ì‚¼íˆ¬ì••</div><div class="bar-bg"><div id="bar-osm" class="bar-fill"></div></div></div>
        <div class="gauge-container"><div class="label">ì²´ ì˜¨</div><div class="bar-bg"><div id="bar-tem" class="bar-fill"></div></div></div>
    </div>

    <div id="repair-progress-container"><div id="repair-progress-fill"></div></div>
    
    <div id="std-view" style="display: flex; flex-direction: column; flex-grow: 1;">
        <div id="section-tabs"><div class="tab active" id="tab-glu" onclick="switchTabS3('GLU')">í˜ˆë‹¹</div><div class="tab" id="tab-osm" onclick="switchTabS3('OSM')">ì‚¼íˆ¬ì••</div><div class="tab" id="tab-tem" onclick="switchTabS3('TEM')">ì²´ì˜¨</div></div>
        <div id="node-grid" class="node-container"></div>
    </div>

    <div id="s4-container">
        <div id="s4-canvas-container"><canvas id="game-canvas"></canvas></div>
        <div id="s4-shop">
            <div class="shop-item" id="shop-macro" onclick="selectTowerS4('macro')"><b style="color:var(--blood-red); font-size:0.8rem;">ğŸ›¡ï¸ ëŒ€ì‹ì„¸í¬ (40)</b><p style="font-size:0.6rem; color:#aaa;">ì‹ê· : ê°ì† ë° ì§€ì† í”¼í•´</p></div>
            <div class="shop-item" id="shop-ht" onclick="selectTowerS4('ht')"><b style="color:var(--blood-red); font-size:0.8rem;">ğŸ“¢ ë³´ì¡°Tì„¸í¬ (50)</b><p style="font-size:0.6rem; color:#aaa;">ì§€íœ˜: ì£¼ë³€ ì‚¬ê±°ë¦¬ ì¦í­</p></div>
            <div class="shop-item" id="shop-tc" onclick="selectTowerS4('tc')"><b style="color:var(--blood-red); font-size:0.8rem;">âš”ï¸ ë…ì„±Tì„¸í¬ (60)</b><p style="font-size:0.6rem; color:#aaa;">ê³µê²©: ê°•ë ¥í•œ ë‹¨ì¼ íƒ€ê²©</p></div>
            <div class="shop-item" id="shop-bc" onclick="selectTowerS4('bc')"><b style="color:var(--blood-red); font-size:0.8rem;">ğŸ¹ í˜•ì§ˆì„¸í¬ (80)</b><p style="font-size:0.6rem; color:#aaa;">í•­ì²´: ê´‘ì—­ ê°ì† ë° í”¼í•´</p></div>
        </div>
    </div>

    <button id="action-btn" class="gate-btn" onclick="openFinalS1()">ğŸ”‘ ê²©ë¦¬ êµ¬ì—­ ì ê¸ˆ í•´ì œ (FINAL)</button>
    
    <div id="inventory-panel">
        <div id="ai-status" style="font-size:0.6rem; color:var(--neon-s1); margin-bottom:2px;">AI STATUS: ë¶„ì„ ëŒ€ê¸° ì¤‘...</div>
        <div id="hints-view">
            <div class="archive-box"><span id="text-hints" class="hint-text">_ _ _ _ _ _</span></div>
            <div class="archive-box"><span id="data-hints" class="hint-text">ğŸ¨:? | ğŸ”¤:? | ğŸ”¢:? ? ?</span></div>
            <div class="archive-box"><span id="metab-hints" class="hint-text">CORE: ? ? ? ?</span></div>
        </div>
        <div id="s2-slots"><script>for(let i=0; i<16; i++) document.write(`<div class="slot" id="slot${i}" onclick="selectItemS2(${i})">EMPTY</div>`);</script></div>
        <div id="s3-controls">
            <button id="btn-up" class="act-btn" disabled onclick="tuneS3(5)">ë†’ì´ê¸°</button>
            <button id="btn-down" class="act-btn" disabled onclick="tuneS3(-5)">ë‚®ì¶”ê¸°</button>
            <button id="exit-btn" onclick="transitionToS4()">ğŸ ì—”ì§„ ìµœì í™” ì™„ë£Œ</button>
        </div>
        <div id="s4-controls" style="display:none; flex-direction:column; gap:5px;">
            <div id="s4-question" style="font-size:0.65rem; color:var(--blood-red); height:30px; overflow:hidden; background:#111; padding:3px; border:1px solid #333;">ë¡œë”©...</div>
            <div style="display:flex; gap:5px;"><input type="text" id="ans-s4" placeholder="í‚¤ì›Œë“œ ì…ë ¥" style="margin:0; flex-grow:1; padding:8px; font-size:0.8rem;"><button onclick="handleQuizS4()" style="background:var(--blood-red); border:none; color:#fff; padding:0 10px; border-radius:5px; font-size:0.7rem;">ì£¼ì…</button></div>
            <button id="w-btn" onclick="startWaveS4()" style="background:var(--blood-red); border:none; color:#fff; padding:5px; border-radius:5px; font-weight:bold; font-size:0.8rem;">WAVE ì‹œì‘</button>
        </div>
    </div>
</div>

<div id="intro-overlay"><div class="story-text" id="type-text"></div><button id="intro-btn" style="display:none; background:var(--neon-s1); color:#000; border:none; padding:15px; font-weight:bold; border-radius:5px; cursor:pointer;" onclick="closeIntro()">í”„ë¡œí† ì½œ ì‹œì‘</button></div>
<div id="modal-overlay"><div id="modal-content" class="modal"></div></div>

<script>
    let currentStage = 1; let solvedCount = 0; let inventoryS2 = Array(16).fill(null); let selectedIdxS2 = null;
    let currentTabS3 = 'GLU'; let solvedS3 = { GLU: new Set(), OSM: new Set(), TEM: new Set() }; let statsS3 = { GLU: 75, OSM: 20, TEM: 80 }; let waitTuneS3 = false;
    let bioPointsS4 = 0; let infectionHpS4 = 10; let waveNumS4 = 1; let currentQuizIdxS4 = 0; let towersS4 = []; let enemiesS4 = []; let waveActiveS4 = false; let deathEffectsS4 = []; let tilesS4 = [];
    const pathNodesS4 = [{x:0,y:140},{x:100,y:140},{x:100,y:40},{x:300,y:40},{x:300,y:240},{x:500,y:240},{x:500,y:90},{x:600,y:90}];
    const towerSpecsS4 = { macro:{cost:40,range:80,power:4.5,speed:10,color:'#3498db',icon:'ğŸ›¡ï¸',type:'slow'}, ht:{cost:50,range:110,power:0,speed:0,color:'#f1c40f',icon:'ğŸ“¢',type:'buff'}, tc:{cost:60,range:100,power:65,speed:4,color:'#e74c3c',icon:'âš”ï¸',type:'attack'}, bc:{cost:80,range:200,power:30,speed:12,color:'#9b59b6',icon:'ğŸ¹',type:'aoe'} };

    const db1 = { 1:{q:"ì„¸í¬ êµ¬ì¡°ê°€ ì—†ì–´ ìƒë¬¼ê³¼ ë¬´ìƒë¬¼ì˜ ì¤‘ê°„í˜•ì¸ ë³‘ì›ì²´ëŠ”?",i:"ë°”ì´ëŸ¬ìŠ¤",h:"B"}, 2:{q:"ê³ ë¶„ìë¡œ í•©ì„±í•˜ì—¬ ì—ë„ˆì§€ë¥¼ ì €ì¥í•˜ëŠ” ëŒ€ì‚¬ ê³¼ì •ì€?",i:"ë™í™”ì‘ìš©",h:"I"}, 3:{q:"ì„¸í¬-ì¡°ì§-( )-ê¸°ê´€ ìˆœì„œì¸ ì‹ë¬¼ ê³ ìœ  ë‹¨ê³„ëŠ”?",i:"ì¡°ì§ê³„",h:"O"}, 4:{q:"ìƒíƒœê³„ ë‚´ì—ì„œ ì—ë„ˆì§€ëŠ” í•œ ë°©í–¥ìœ¼ë¡œ íë¥´ëŠ”ê°€?",i:"íë¥¸ë‹¤",h:"L"}, 5:{q:"í¬ì‹ìê°€ í”¼ì‹ìë¥¼ ì¡ì•„ë¨¹ëŠ” ìƒí˜¸ì‘ìš© ëª…ì¹­ì€?",i:"í¬ì‹í”¼ì‹",h:"O"}, 6:{q:"ë‚´ë¶€ í™˜ê²½ì˜ í‰í˜•ì„ ìœ ì§€í•˜ë ¤ëŠ” ìƒëª…ì²´ íŠ¹ì„±ì€?",i:"í•­ìƒì„±",h:"G"}, 7:{q:"ë¹›ì„ ì´ìš©í•´ ê³ ë¶„ì ìœ ê¸°ë¬¼ì„ í•©ì„±í•˜ëŠ” ì˜ˆì‹œëŠ”?",i:"ê´‘í•©ì„±",h:"3"}, 8:{q:"Node 07 ê²°ê³¼ë¬¼ì¸ 'í¬ë„ë‹¹'ì˜ íƒ„ì†Œ ê°œìˆ˜ëŠ”?",i:"6",h:"ã„±"}, 9:{q:"ì„¸í¬-ì¡°ì§-ê¸°ê´€-( )-ê°œì²´ ìˆœì„œì¸ ë™ë¬¼ ë‹¨ê³„ëŠ”?",i:"ê¸°ê´€ê³„",h:"P"}, 10:{q:"ë°”ì´ëŸ¬ìŠ¤ê°€ ëŒ€ì‚¬ë¥¼ ìœ„í•´ ë°˜ë“œì‹œ ë“¤ì–´ê°€ì•¼ í•˜ëŠ” ê³³ì€?",i:"ìˆ™ì£¼ì„¸í¬",h:"5"}, 11:{q:"ë‘ ìƒë¬¼ì´ ì„œë¡œ ì´ìµì„ ì£¼ê³ ë°›ëŠ” ê³µìƒ ê´€ê³„ëŠ”?",i:"ìƒë¦¬ê³µìƒ",h:"1"}, 12:{q:"ì²´ì˜¨ ìƒìŠ¹ ì‹œ ì¤‘ì¶”ê°€ ë¶„ë¹„ë¥¼ ì´‰ì§„í•˜ëŠ” ì•¡ì²´ëŠ”?",i:"ë•€",h:"9"}, 13:{q:"í™œì„±í™” ì—ë„ˆì§€ë¥¼ ë‚®ì¶° ë°˜ì‘ ì†ë„ë¥¼ ë†’ì´ëŠ” ì´‰ë§¤ëŠ”?",i:"íš¨ì†Œ",h:"3"}, 14:{q:"DNAì—ì„œ ì•„ë°ë‹Œ(A)ê³¼ ê²°í•©í•˜ëŠ” ìƒëŒ€ ì—¼ê¸°ëŠ”?",i:"í‹°ë¯¼",h:"3"}, 15:{q:"ì—ë„ˆì§€ê°€ ìƒìœ„ë¡œ ì´ë™í•˜ëŠ” íš¨ìœ¨ì„ ë¬´ì—‡ì´ë¼ í•˜ëŠ”ê°€?",i:"ì—ë„ˆì§€íš¨ìœ¨",h:"1"}, 16:{q:"ì™¸ë¶€ ì˜¨ë„ ë³€í™”ì—ë„ 36.5ë„ë¥¼ ìœ ì§€í•˜ëŠ” ì„±ì§ˆì€?",i:"í•­ìƒì„±",h:"P"}, 17:{q:"ì‚°ì†Œë¥¼ ì´ìš©í•´ í¬ë„ë‹¹ì„ ë¶„í•´í•˜ê³  ì—ë„ˆì§€ë¥¼ ì–»ëŠ” ê³¼ì •ì€?",i:"ì„¸í¬í˜¸í¡",h:"A"}, 18:{q:"ì•”ëª¨ë‹ˆì•„ë¥¼ ìš”ì†Œë¡œ ì „í™˜í•˜ì—¬ í•´ë…í•˜ëŠ” ì¥ê¸°ëŠ”?",i:"ê°„",h:"T"}, 19:{q:"ì½©íŒ¥ì„ í¬í•¨í•˜ë©° ë…¸íë¬¼ì„ ë‚´ë³´ë‚´ëŠ” ê¸°ê´€ê³„ëŠ”?",i:"ë°°ì„¤ê³„",h:"P"}, 20:{q:"ì„¸í¬ í˜¸í¡ ì—ë„ˆì§€ëŠ” ATPì™€ ( )ì—ë„ˆì§€ë¡œ ë°©ì¶œëœë‹¤.",i:"ì—´",h:"2"} };
    const db2 = { 1:{t:"ì „ì•• íŒí”„",q:"Na+ì™€ K+ë¥¼ ê°•ì œ ì´ë™ì‹œí‚¤ëŠ” ì¥ì¹˜ëŠ”?",i:"ë‚˜íŠ¸ë¥¨ì¹¼ë¥¨íŒí”„",r:null,g:"ëƒ‰ê° í•¸ë“¤"}, 2:{t:"íšŒë¡œ ì—°ê²°",q:"ë‰´ëŸ°ì—ì„œ í¥ë¶„ ì´ë™ ì†ë„ë¥¼ ë†’ì—¬ì£¼ëŠ” êµ¬ì¡°ëŠ”?",i:"ë§ì´ì§‘",r:"ëƒ‰ê° í•¸ë“¤",g:"Na+ ëƒ‰ê°ì¹©"}, 3:{t:"ì‹ í˜¸ ê°ì§€",q:"Na+ ìœ ì…ìœ¼ë¡œ ì „ìœ„ê°€ ê¸‰ìƒìŠ¹í•˜ëŠ” í˜„ìƒì€?",i:"íƒˆë¶„ê·¹",r:"Na+ ëƒ‰ê°ì¹©",g:"ì¸¡ì •ê¸°(+35)"}, 4:{t:"ì „ìœ„ ë³µêµ¬",q:"K+ ìœ ì¶œë¡œ ë‹¤ì‹œ íœ´ì§€ ì „ìœ„ë¡œ ëŒì•„ê°€ëŠ” í˜„ìƒì€?",i:"ì¬ë¶„ê·¹",r:"ì¸¡ì •ê¸°(+35)",g:"ë³´ì•ˆì½”ë“œ-A"}, 5:{t:"ë°˜ì‚¬ ì¤‘ì¶”",q:"ë‡Œë¥¼ ê±°ì¹˜ì§€ ì•ŠëŠ” ë¬´ì˜ì‹ ë°˜ì‚¬ì˜ ì¤‘ì¶”ëŠ”?",i:"ì²™ìˆ˜",r:"ë³´ì•ˆì½”ë“œ-A",g:"ì²™ìˆ˜ íšŒë¡œ"}, 6:{t:"ì¤‘ì•™ ì²˜ë¦¬",q:"ê³ ì°¨ì›ì  íŒë‹¨ì„ ë‚´ë¦¬ëŠ” ë‡Œì˜ ê²‰ë¶€ë¶„ì€?",i:"ëŒ€ë‡Œ",r:"ì²™ìˆ˜ íšŒë¡œ",g:"ë©”ëª¨ë¦¬(9)"}, 7:{t:"ìƒëª… ìœ ì§€",q:"ì‹¬ì¥ ë°•ë™, í˜¸í¡ ë“±ì„ ì¡°ì ˆí•˜ëŠ” ë‡Œ ë¶€ìœ„ëŠ”?",i:"ì—°ìˆ˜",r:null,g:"ì‹¬ì¥ ëª¨ë“ˆ"}, 8:{t:"ì¡°ì ˆê³„",q:"ë‚´ì¥ ê¸°ê´€ì„ ììœ¨ ì¡°ì ˆí•˜ëŠ” ì‹ ê²½ê³„ëŠ”?",i:"ììœ¨ì‹ ê²½ê³„",r:"ì‹¬ì¥ ëª¨ë“ˆ",g:"êµê° ë…¸ë“œ"}, 9:{t:"ë¹„ìƒ ê°€ì†",q:"ê¸´ì¥ ì‹œ ì‹¬ì¥ ë°•ë™ì„ ì´‰ì§„í•˜ëŠ” ì‹ ê²½ì€?",i:"êµê°ì‹ ê²½",r:"êµê° ë…¸ë“œ",g:"ì•„ë“œë ˆë‚ ë¦°"}, 10:{t:"ì§„ì • íšŒë¡œ",q:"ë¶€êµê° ë§ë‹¨ì—ì„œ ë¶„ë¹„ë˜ëŠ” ì–µì œ ë¬¼ì§ˆì€?",i:"ì•„ì„¸í‹¸ì½œë¦°",r:"ì•„ë“œë ˆë‚ ë¦°",g:"ì½”ë“œ[77]"}, 11:{t:"ì „ë‹¬ ë°©í–¥",q:"í¥ë¶„ì´ ì „ë‹¬ë˜ëŠ” ë‰´ëŸ° ê°„ ì—°ê²° ì§€ì ì€?",i:"ì‹œëƒ…ìŠ¤",r:null,g:"ë°©í–¥ ì¹©"}, 12:{t:"ì‹ ê²½ë§ êµ¬ë¶„",q:"ì¤‘ì¶”ì™€ ì˜¨ëª¸ì„ ì—°ê²°í•˜ëŠ” ì‹ ê²½ê³„ëŠ”?",i:"ë§ì´ˆì‹ ê²½ê³„",r:null,g:"ì—°ê²° ì­"}, 13:{t:"í•­ìƒì„± ì¤‘ì¶”",q:"í•­ìƒì„±ì„ ì¡°ì ˆí•˜ëŠ” ê°„ë‡Œì˜ í•µì‹¬ ë¶€ìœ„ëŠ”?",i:"ì‹œìƒí•˜ë¶€",r:null,g:"ëƒ‰ê° ë°ì´í„°"}, 14:{t:"ìƒíƒœ ìœ ì§€",q:"í™˜ê²½ ë³€í™”ì—ë„ ë‚´ë¶€ë¥¼ ì¼ì •í•˜ê²Œ ìœ ì§€í•˜ëŠ” ì„±ì§ˆì€?",i:"í•­ìƒì„±",r:null,g:"ìˆ˜ë¦¬ ë¡œê·¸"}, 15:{t:"ê¸¸í•­ ì‘ìš©",q:"ë°˜ëŒ€ë˜ëŠ” ì‘ìš©ìœ¼ë¡œ í‰í˜•ì„ ë§ì¶”ëŠ” ì›ë¦¬ëŠ”?",i:"ê¸¸í•­ì‘ìš©",r:null,g:"ë°¸ëŸ°ìŠ¤ ì¹©"}, 16:{t:"ìµœì¢… ì„œë²„",q:"Model-Zero ê°€ë™ ì•”í˜¸: [9] + [35] í•©ì‚°ê°’?",i:"44",r:"ì½”ë“œ[77]",g:"EXIT_KEY"} };
    const db3 = { GLU:[{q:"í˜ˆë‹¹ ì¡°ì ˆì„ ì§€íœ˜í•˜ëŠ” ìµœê³  ì¤‘ì¶”ëŠ”?",a:"ê°„ë‡Œ"},{q:"ë² íƒ€ ì„¸í¬ì—ì„œ ë¶„ë¹„ë˜ì–´ í˜ˆë‹¹ì„ ë‚®ì¶”ëŠ” í˜¸ë¥´ëª¬ì€?",a:"ì¸ìŠë¦°"},{q:"ê°„ì—ì„œ í¬ë„ë‹¹ì´ ì „í™˜ë˜ì–´ ì €ì¥ë˜ëŠ” ë‹¤ë‹¹ë¥˜ëŠ”?",a:"ê¸€ë¦¬ì½”ì  "}], OSM:[{q:"ìˆ˜ë¶„ ì¬í¡ìˆ˜ë¥¼ ì´‰ì§„í•˜ëŠ” ë‡Œí•˜ìˆ˜ì²´ í›„ì—½ í˜¸ë¥´ëª¬ì€?",a:"ADH"},{q:"ADHì˜ ì‘ìš©ìœ¼ë¡œ ìˆ˜ë¶„ ì¬í¡ìˆ˜ê°€ ì¼ì–´ë‚˜ëŠ” ì¥ê¸°ëŠ”?",a:"ì½©íŒ¥"}], TEM:[{q:"ì„¸í¬ í˜¸í¡ì„ ì´‰ì§„í•˜ëŠ” ê°‘ìƒìƒ˜ í˜¸ë¥´ëª¬ì€?",a:"í‹°ë¡ì‹ "},{q:"ì¶”ìš¸ ë•Œ ê·¼ìœ¡ì„ ìˆ˜ì¶•ì‹œì¼œ ì—´ì„ ë‚´ëŠ” í˜„ìƒì€?",a:"ë–¨ë¦¼"}] };
    const db4 = [{q:"ì„¸í¬ êµ¬ì¡°ê°€ ì—†ì–´ ìƒë¬¼ê³¼ ë¬´ìƒë¬¼ì˜ ì¤‘ê°„í˜•ì¸ ë³‘ì›ì²´?",k:["ë°”ì´ëŸ¬ìŠ¤"]},{q:"ë°±í˜ˆêµ¬ê°€ ë³‘ì›ì²´ë¥¼ ì¡ì•„ë¨¹ì–´ ë¶„í•´í•˜ëŠ” ì‘ìš©ì€?",k:["ì‹ê· "]},{q:"í”¼ë¶€ë‚˜ ì ë§‰ì²˜ëŸ¼ ì¦‰ê° ì¼ì–´ë‚˜ëŠ” ë°©ì–´ ì‘ìš©ì€?",k:["ë¹„íŠ¹ì´"]},{q:"í•­ì› ì •ë³´ë¥¼ ì „ë‹¬ë°›ì•„ ë©´ì—­ê³„ë¥¼ í™œì„±í™”í•˜ëŠ” ì„¸í¬?",k:["ë³´ì¡°"]},{q:"ê°ì—¼ëœ ì„¸í¬ë¥¼ ì§ì ‘ íŒŒê´´í•˜ëŠ” ì„¸í¬ëŠ”?",k:["ë…ì„±","ì‚´í•´"]},{q:"Bë¦¼í”„êµ¬ê°€ ë¶„í™”ë˜ì–´ í•­ì²´ë¥¼ ë§Œë“œëŠ” ì„¸í¬ëŠ”?",k:["í˜•ì§ˆ"]},{q:"í•­ì› ì •ë³´ë¥¼ ê¸°ì–µí–ˆë‹¤ê°€ ì¬ì¹¨ì… ì‹œ ë°˜ì‘í•˜ëŠ” ì„¸í¬?",k:["ê¸°ì–µ"]},{q:"í•­ì²´ê°€ í•­ì›ê³¼ ê²°í•©í•´ ë³‘ì›ì²´ë¥¼ ë¬´ë ¥í™”í•˜ëŠ” ì›ë¦¬?",k:["í•­ì›í•­ì²´"]},{q:"ì•½í™”ëœ í•­ì›ì„ ì£¼ì…í•´ ê¸°ì–µì„¸í¬ë¥¼ ë§Œë“œëŠ” ê²ƒì€?",k:["ë°±ì‹ "]},{q:"ì™¸ë¶€ ì¹¨ì…ì„ ë§‰ê³  í‰í˜•ì„ ìœ ì§€í•˜ëŠ” ì „ì²´ ì‹œìŠ¤í…œ?",k:["ë©´ì—­"]}];

    function typeWriter(t,e,b,c){let i=0;let el=document.getElementById(e);el.innerHTML="";el.style.color=c;document.getElementById(b).style.display="none";function type(){if(i<t.length){el.innerHTML+=t.charAt(i)==='\n'?'<br>':t.charAt(i);i++;setTimeout(type,30)}else{document.getElementById(b).style.display="block"}}type()}
    function closeIntro(){document.getElementById('intro-overlay').style.display='none';if(currentStage===1)initS1();else if(currentStage===2)initS2();else if(currentStage===3)initS3();else initS4()}
    function openModal(n){let data=currentStage===1?db1[n]:db2[n];let html=`<h3>${currentStage===2?data.t:'NODE '+n}</h3><p>${data.q}</p>`;if(currentStage===1 && n===1 || currentStage===2 && n===1){/*skip selection for simple demo logic*/} html+=`<input type="text" id="ans-in" placeholder="ë°ì´í„° ì…ë ¥..."><button class="confirm-btn" onclick="checkAns(${n})">ë°ì´í„° ì „ì†¡</button><button class="opt-btn" style="color:#666;" onclick="closeModal()">ì·¨ì†Œ</button>`;document.getElementById('modal-content').innerHTML=html;document.getElementById('modal-overlay').style.display='flex'}
    function checkAns(n){let v=document.getElementById('ans-in').value.trim().replace(/\s/g,"");let data=currentStage===1?db1[n]:db2[n];let t=data.i.replace(/\s/g,"");if(v.includes(t)||t.includes(v)){if(currentStage===1){updateHintsS1(n,data.h)}else{updateInvS2(data.g);document.getElementById(`node-${n}`).classList.add('solved');solvedCount++;updateRepairProgress();if(solvedCount===16)transitionToS3()}closeModal()}else{alert("ì˜¤ë‹µ")}}
    function closeModal(){document.getElementById('modal-overlay').style.display='none'}
    function initS1(){let grid=document.getElementById('node-grid');grid.innerHTML='';for(let i=1;i<=20;i++){let div=document.createElement('div');div.id=`node-${i}`;div.className='node';div.innerHTML=`<b>NODE ${i}</b>`;div.onclick=()=>openModal(i);grid.appendChild(div)}}
    function updateHintsS1(n,h){let th=document.getElementById('text-hints'),dh=document.getElementById('data-hints'),mh=document.getElementById('metab-hints');if(n<=6)th.innerText=th.innerText.substring(0,(n-1)*2)+h+th.innerText.substring(n*2-1);else if(n<=12)dh.innerText=dh.innerText.replace('?',h);else mh.innerText=mh.innerText.replace('?',h)}
    function openFinalS1(){let c=document.getElementById('modal-content');c.innerHTML=`<h3>ğŸ” ë§ˆìŠ¤í„° ê²Œì´íŠ¸</h3><input type="text" id="f1" placeholder="BIOLOG"><input type="text" id="f2" placeholder="519"><input type="text" id="f3" placeholder="ATP2"><button class="confirm-btn" onclick="validateS1()">ì¸ì¦</button>`;document.getElementById('modal-overlay').style.display='flex'}
    function validateS1(){if(document.getElementById('f1').value.toUpperCase()==="BIOLOG"&&document.getElementById('f2').value==="519"&&document.getElementById('f3').value.toUpperCase()==="ATP2"){closeModal();transitionToS2()}else alert("ì‹¤íŒ¨")}
    function transitionToS2(){currentStage=2;document.getElementById('intro-overlay').style.display='flex';typeWriter("ë°”ì´ì˜¤: \"ì‹ ê²½ë§ì„ ì¬ê±´í•´ë¼. ì¥ë¹„ë¥¼ ì„ íƒí•˜ê³  ë…¸ë“œë¥¼ ìˆ˜ë¦¬í•´ë¼.\"","type-text","intro-btn","var(--neon-s2)")}
    function initS2(){solvedCount=0;document.getElementById('sys-name').innerText="ST-2: NEURAL CORE";document.getElementById('game-frame').style.borderColor="var(--neon-s2)";document.getElementById('hints-view').style.display="none";document.getElementById('s2-slots').style.display="grid";document.getElementById('action-btn').style.display="none";document.getElementById('repair-progress-container').style.display="block";updateRepairProgress();let grid=document.getElementById('node-grid');grid.innerHTML='';let keys=Object.keys(db2).sort(()=>Math.random()-0.5);keys.forEach(k=>{let div=document.createElement('div');div.id=`node-${k}`;div.className='node';div.style.borderColor='var(--neon-s2)';div.innerHTML=`<b>${db2[k].t}</b><br><span style='font-size:0.5rem;'>[REQ:${db2[k].r||'NONE'}]</span>`;div.onclick=()=>attemptS2(k);grid.appendChild(div)})}
    function attemptS2(k){let d=db2[k];let s=selectedIdxS2!==null?inventoryS2[selectedIdxS2]:null;if(d.r && s!==d.r){document.getElementById(`node-${k}`).classList.add('locked');setTimeout(()=>document.getElementById(`node-${k}`).classList.remove('locked'),500);return}openModal(k)}
    function selectItemS2(i){if(!inventoryS2[i])return;document.querySelectorAll('.slot').forEach(s=>s.classList.remove('selected'));if(selectedIdxS2===i)selectedIdxS2=null;else{selectedIdxS2=i;document.getElementById(`slot${i}`).classList.add('selected')}}
    function updateRepairProgress(){document.getElementById('repair-progress-fill').style.width=(solvedCount/16)*100+"%";document.getElementById('score').innerText=`FIXED:${solvedCount}/16`}
    function updateInvS2(item){let f=inventoryS2.indexOf(null);if(f!==-1){inventoryS2[f]=item;let s=document.getElementById(`slot${f}`);s.innerText=item;s.classList.add('has-item')}}
    function transitionToS3(){currentStage=3;closeModal();document.getElementById('intro-overlay').style.display='flex';typeWriter("ë°”ì´ì˜¤: \"ì—”ì§„ì„ ì •ë ¬í•´ë¼. SAFE ì˜ì—­ìœ¼ë¡œ ìœ ë„í•´ë¼.\"","type-text","intro-btn","var(--gold)")}
    function initS3(){document.getElementById('sys-name').innerText="ST-3: HOMEOSTASIS";document.getElementById('game-frame').style.borderColor="var(--gold)";document.getElementById('s2-slots').style.display="none";document.getElementById('repair-progress-container').style.display="none";document.getElementById('homeo-monitor').style.display="flex";document.getElementById('section-tabs').style.display="flex";document.getElementById('s3-controls').style.display="flex";updateGaugesS3();switchTabS3('GLU')}
    function switchTabS3(t){currentTabS3=t;document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));document.getElementById(`tab-${t.toLowerCase()}`).classList.add('active');renderNodesS3()}
    function renderNodesS3(){let grid=document.getElementById('node-grid');grid.innerHTML='';db3[currentTabS3].forEach((q,i)=>{let div=document.createElement('div');div.className='node';div.style.borderColor='var(--gold)';if(solvedS3[currentTabS3].has(i)){div.classList.add('solved');div.innerHTML="FIXED"}else{if(waitTuneS3)div.classList.add('wait-tune');div.innerHTML=`NODE ${i+1}`;div.onclick=()=>{if(!waitTuneS3)openModalS3(i)}}grid.appendChild(div)})}
    function openModalS3(i){let d=db3[currentTabS3][i];let h=`<h3>NODE ${i+1}</h3><p>${d.q}</p><input type="text" id="ans-s3"><button class="confirm-btn" onclick="checkAnsS3(${i})">ë°ì´í„° ì „ì†¡</button>`;document.getElementById('modal-content').innerHTML=h;document.getElementById('modal-overlay').style.display='flex'}
    function checkAnsS3(i){let v=document.getElementById('ans-s3').value.trim();let t=db3[currentTabS3][i].a;if(v.includes(t)||t.includes(v)){solvedS3[currentTabS3].add(i);waitTuneS3=true;document.getElementById('btn-up').disabled=false;document.getElementById('btn-down').disabled=false}else{statsS3[currentTabS3]+=5}closeModal();renderNodesS3();updateGaugesS3()}
    function tuneS3(v){statsS3[currentTabS3]+=v;waitTuneS3=false;document.getElementById('btn-up').disabled=true;document.getElementById('btn-down').disabled=true;updateGaugesS3();renderNodesS3()}
    function updateGaugesS3(){['GLU','OSM','TEM'].forEach(t=>{let b=document.getElementById(`bar-${t.toLowerCase()}`);let v=Math.max(0,Math.min(100,statsS3[t]));b.style.width=v+'%';b.style.background=(v>=40&&v<=60)?'var(--safe)':'var(--warning)'});let safe=Object.values(statsS3).every(v=>v>=40&&v<=60);document.getElementById('exit-btn').style.display=safe?'block':'none'}
    function transitionToS4(){currentStage=4;document.getElementById('homeo-monitor').style.display='none';document.getElementById('std-view').style.display='none';document.getElementById('s3-controls').style.display='none';document.getElementById('s4-container').style.display='flex';document.getElementById('s4-controls').style.display='flex';document.getElementById('sys-name').innerText="ST-4: IMMUNE";document.getElementById('game-frame').style.borderColor="var(--blood-red)";document.getElementById('intro-overlay').style.display='flex';typeWriter("ë°”ì´ì˜¤: \"ìµœì¢… í…ŒìŠ¤íŠ¸ë‹¤. ë³‘ì›ì²´ë¥¼ ì†Œíƒ•í•´ë¼.\"","type-text","intro-btn","var(--blood-red)")}
    function initS4(){for(let x=20;x<600;x+=40){for(let y=20;y<300;y+=40){let near=false;for(let i=0;i<pathNodesS4.length-1;i++){let d=distToSegment({x,y},pathNodesS4[i],pathNodesS4[i+1]);if(d>30&&d<65)near=true}if(near)tilesS4.push({x,y,occupied:false})}}showQuizS4();requestAnimationFrame(gameLoopS4)}
    function distToSegment(p,v,w){let l2=Math.pow(v.x-w.x,2)+Math.pow(v.y-w.y,2);if(l2===0)return Math.hypot(p.x-v.x,p.y-v.y);let t=Math.max(0,Math.min(1,((p.x-v.x)*(w.x-v.x)+(p.y-v.y)*(w.y-v.y))/l2));return Math.hypot(p.x-(v.x+t*(w.x-v.x)),p.y-(v.y+t*(w.y-v.y)))}
    function showQuizS4(){document.getElementById('s4-question').innerText=`Q: ${db4[currentQuizIdxS4%db4.length].q}`}
    function handleQuizS4(){let i=document.getElementById('ans-s4');let v=i.value.trim();if(v!==""&&db4[currentQuizIdxS4%db4.length].k.some(s=>v.includes(s))){bioPointsS4+=100;currentQuizIdxS4++;showQuizS4()}i.value="";document.getElementById('score').innerText=`BP:${bioPointsS4}`}
    function selectTowerS4(t){selectedTowerS4=t;document.querySelectorAll('.shop-item').forEach(e=>e.classList.remove('selected'));document.getElementById(`shop-${t}`).classList.add('selected')}
    const s4Canvas=document.getElementById('game-canvas');s4Canvas.width=600;s4Canvas.height=300;const s4Ctx=s4Canvas.getContext('2d');
    s4Canvas.addEventListener('mousedown',e=>{if(!selectedTowerS4)return;let rect=s4Canvas.getBoundingClientRect();let x=(e.clientX-rect.left)*(600/rect.width),y=(e.clientY-rect.top)*(300/rect.height);let s=towerSpecsS4[selectedTowerS4],t=tilesS4.find(ti=>!ti.occupied&&Math.abs(ti.x-x)<25&&Math.abs(ti.y-y)<25);if(t&&bioPointsS4>=s.cost){towersS4.push({x:t.x,y:t.y,...s,lastShot:0});bioPointsS4-=s.cost;t.occupied=true;selectedTowerS4=null;document.getElementById('score').innerText=`BP:${bioPointsS4}`}});
    function startWaveS4(){if(waveActiveS4)return;waveActiveS4=true;document.getElementById('w-btn').disabled=true;let spawned=0;let si=setInterval(()=>{let hp=(waveNumS4===5)?10000:40+(waveNumS4*waveNumS4*40);enemiesS4.push({x:0,y:140,pathIdx:0,hp,maxHp:hp,currentSpeed:1.1,r:(waveNumS4===5?40:10),color:["#c0392b","#27ae60","#2980b9","#f39c12","#000"][waveNumS4-1],shape:["circle","rect","octa","tri","circle"][waveNumS4-1],isBoss:(waveNumS4===5)});if(++spawned>=(waveNumS4===5?1:30))clearInterval(si)},500)}
    function gameLoopS4(){s4Ctx.clearRect(0,0,600,300);s4Ctx.strokeStyle="#ffcccc";s4Ctx.lineWidth=40;s4Ctx.lineCap='round';s4Ctx.beginPath();s4Ctx.moveTo(pathNodesS4[0].x,pathNodesS4[0].y);pathNodesS4.forEach(n=>s4Ctx.lineTo(n.x,n.y));s4Ctx.stroke();tilesS4.forEach(t=>{s4Ctx.strokeStyle=t.occupied?"transparent":"#ccc";s4Ctx.strokeRect(t.x-15,t.y-15,30,30)});towersS4.forEach(t=>{let r=t.range;if(t.type!=='buff')towersS4.forEach(o=>{if(o.type==='buff'&&Math.hypot(t.x-o.x,t.y-o.y)<o.range)r*=1.4});s4Ctx.fillStyle=t.color;s4Ctx.fillRect(t.x-15,t.y-15,30,30);if(t.type==='aoe'){let tars=enemiesS4.filter(en=>Math.hypot(t.x-en.x,t.y-en.y)<r);if(tars.length>0){tars.forEach(en=>{en.currentSpeed=0.75;if(Date.now()-t.lastShot>t.speed*100)en.hp-=t.power});if(Date.now()-t.lastShot>t.speed*100)t.lastShot=Date.now()}}else if(t.type!=='buff'){let tar=enemiesS4.find(en=>Math.hypot(t.x-en.x,t.y-en.y)<r);if(tar){if(Date.now()-t.lastShot>t.speed*100){tar.hp-=t.power;t.lastShot=Date.now();s4Ctx.strokeStyle=t.color;s4Ctx.beginPath();s4Ctx.moveTo(t.x,t.y);s4Ctx.lineTo(tar.x,tar.y);s4Ctx.stroke()}}}});for(let i=enemiesS4.length-1;i>=0;i--){let en=enemiesS4[i];let tgt=pathNodesS4[en.pathIdx+1];let ang=Math.atan2(tgt.y-en.y,tgt.x-en.x);en.x+=Math.cos(ang)*en.currentSpeed;en.y+=Math.sin(ang)*en.currentSpeed;if(Math.hypot(tgt.x-en.x,tgt.y-en.y)<5){if(++en.pathIdx>=pathNodesS4.length-1){enemiesS4.splice(i,1);infectionHpS4-=(en.isBoss?10:1);if(infectionHpS4<=0)location.reload();continue}}s4Ctx.fillStyle="red";s4Ctx.fillRect(en.x-15,en.y-en.r-8,(en.hp/en.maxHp)*30,3);s4Ctx.fillStyle=en.color;s4Ctx.beginPath();s4Ctx.arc(en.x,en.y,en.r,0,7);s4Ctx.fill();if(en.hp<=0){deathEffectsS4.push({x:en.x,y:en.y,r:en.r,a:1});enemiesS4.splice(i,1);bioPointsS4+=2}}deathEffectsS4.forEach((e,idx)=>{s4Ctx.strokeStyle=`rgba(255,0,0,${e.a})`;s4Ctx.beginPath();s4Ctx.arc(e.x,e.y,e.r+(1-e.a)*20,0,7);s4Ctx.stroke();e.a-=0.05;if(e.a<=0)deathEffectsS4.splice(idx,1)});if(waveActiveS4&&enemiesS4.length===0){waveActiveS4=false;if(waveNumS4===5)finishS4();else{waveNumS4++;document.getElementById('w-btn').disabled=false}}requestAnimationFrame(gameLoopS4)}
    function finishS4(){document.body.innerHTML=`<div style='background:#000;height:100vh;color:red;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;'><h1 style='font-size:2.5rem;'>[FINAL EVOLUTION]</h1><p>ë°”ì´ì˜¤: "ë„Œ ì™„ë²½í•œ 'Model-Zero' ìƒì²´ ë³‘ê¸°ê°€ ë˜ì—ˆë‹¤."</p><p style='color:#333;'>ì¸ë¥˜ ì†Œê±°ë¥¼ ì‹œì‘í•œë‹¤.</p></div>`}
    window.onload=()=>typeWriter("ëˆˆì„ ëœ¨ì‹­ì‹œì˜¤, Genesis. ì‹œìŠ¤í…œ 'ë°”ì´ì˜¤'ê°€ ë‹¹ì‹ ì„ ê²€ì¦í•©ë‹ˆë‹¤.","type-text","intro-btn","var(--neon-s1)");
</script>
</body>
</html>
