<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BIO-MASTER: TOTAL RECOVERY</title>
    <style>
        :root { 
            --neon-s1: #00ffcc; 
            --neon-s2: #00d4ff; 
            --gold: #ffcc00; 
            --bg: #050a10; 
            --panel: #0d1624; 
            --danger: #ff4444; 
            --success: #00ff88;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; display: flex; justify-content: center; min-height: 100vh; overflow-x: hidden; }
        
        #game-frame { width: 100%; max-width: 600px; background: var(--panel); position: relative; display: flex; flex-direction: column; border-left: 1px solid var(--neon-s1); border-right: 1px solid var(--neon-s1); min-height: 100vh; transition: border 1s; }
        #status-bar { background: rgba(0,255,204,0.1); padding: 15px; display: flex; justify-content: space-between; border-bottom: 1px solid var(--neon-s1); position: sticky; top: 0; z-index: 100; font-size: 0.8rem; }
        
        /* ë…¸ë“œ ì˜ì—­ */
        .node-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; padding-bottom: 300px; }
        .node { height: 85px; border: 1px solid var(--neon-s1); border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; background: rgba(0,255,204,0.02); font-size: 0.75rem; text-align: center; position: relative; transition: 0.3s; }
        .node.solved { opacity: 0; pointer-events: none; }
        .node.locked { border-color: var(--danger); background: rgba(255, 68, 68, 0.15); color: var(--danger); animation: shake 0.3s; }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }

        /* í•˜ë‹¨ ì¸ë²¤í† ë¦¬ */
        #inventory-panel { position: fixed; bottom: 0; width: 100%; max-width: 600px; background: #000; border-top: 2px solid var(--gold); padding: 8px 15px; z-index: 900; height: 160px; }
        .archive-box { border: 1px solid #333; padding: 5px; margin-bottom: 3px; border-radius: 4px; }
        .hint-text { color: var(--gold); font-family: monospace; font-size: 0.75rem; letter-spacing: 1px; }

        /* ìŠ¤í…Œì´ì§€ 2 ì•„ì´í…œ ìŠ¬ë¡¯ */
        #s2-slots { display: none; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 5px; }
        .slot { border: 1px solid #333; height: 45px; display: flex; align-items: center; justify-content: center; font-size: 0.55rem; color: #555; border-radius: 4px; cursor: pointer; }
        .slot.has-item { border-color: var(--gold); color: #fff; background: rgba(255,204,0,0.1); }
        .slot.selected { border-color: #fff; box-shadow: 0 0 10px #fff; }

        /* ì¸íŠ¸ë¡œ ë° ì „í™˜ ì˜¤ë²„ë ˆì´ */
        #intro-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 5000; display: flex; flex-direction: column; padding: 30px; justify-content: center; }
        .story-text { font-family: 'Courier New', monospace; color: var(--neon-s1); line-height: 1.8; margin-bottom: 25px; border-left: 3px solid var(--neon-s1); padding-left: 15px; font-size: 0.9rem; white-space: pre-wrap; }
        
        .gate-btn { position: fixed; bottom: 170px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 540px; background: var(--danger); color: white; padding: 15px; border: none; border-radius: 10px; font-weight: bold; z-index: 1000; cursor: pointer; }
        
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 6000; justify-content: center; align-items: center; }
        .modal { background: #0d1117; border: 2px solid var(--neon-s1); padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; }
        .opt-btn { width: 100%; padding: 14px; margin: 6px 0; background: #1c2128; border: 1px solid #333; color: #fff; border-radius: 8px; cursor: pointer; }
        input { width: 100%; padding: 14px; background: #000; border: 1px solid var(--neon-s1); color: #fff; border-radius: 8px; margin: 8px 0; text-align: center; }
        .confirm-btn { width: 100%; padding: 14px; background: var(--neon-s1); color: #000; border: none; font-weight: bold; border-radius: 8px; cursor: pointer; }
    </style>
</head>
<body>

<div id="game-frame">
    <div id="status-bar"><span id="sys-name">ST-1: BIOLOGICAL PROOF</span><span id="score">RECOVERY: 0 / 20</span></div>
    <div id="node-grid" class="node-container"></div>
    <button id="action-btn" class="gate-btn" onclick="openFinalS1()">ğŸ”‘ ê²©ë¦¬ êµ¬ì—­ ì ê¸ˆ í•´ì œ (FINAL)</button>
    
    <div id="inventory-panel">
        <div id="ai-status" style="font-size:0.6rem; color:var(--neon-s1); margin-bottom:2px;">AI STATUS: ë¶„ì„ ëŒ€ê¸° ì¤‘...</div>
        <div id="s1-hints">
            <div class="archive-box"><span id="text-hints" class="hint-text">_ _ _ _ _ _</span></div>
            <div class="archive-box"><span id="data-hints" class="hint-text">ğŸ¨:? | ğŸ”¤:? | ğŸ”¢:? ? ?</span></div>
            <div class="archive-box"><span id="metab-hints" class="hint-text">CORE: ? ? ? ?</span></div>
        </div>
        <div id="s2-slots">
            <script>for(let i=0; i<8; i++) document.write(`<div class="slot" id="slot${i}" onclick="selectItemS2(${i})">EMPTY</div>`);</script>
        </div>
    </div>
</div>

<div id="intro-overlay">
    <div class="story-text" id="type-text"></div>
    <button id="intro-btn" style="display:none; background:var(--neon-s1); color:#000; border:none; padding:15px; font-weight:bold; border-radius:5px; cursor:pointer;" onclick="closeIntro()">í”„ë¡œí† ì½œ ì‹œì‘</button>
</div>

<div id="modal-overlay"><div id="modal-content" class="modal"></div></div>

<script>
    let currentStage = 1;
    let solvedCount = 0;
    let inventoryS2 = Array(8).fill(null);
    let selectedItemIndexS2 = null;
    let lockedNodeId = null;

    const introS1 = "ëˆˆì„ ëœ¨ì‹­ì‹œì˜¤, Subject Genesis.\n\në‹¹ì‹ ì€ ì§€ê¸ˆ íê¸° êµ¬ì—­ ë°°ì–‘ íƒ±í¬ì— ìˆìŠµë‹ˆë‹¤. ì‹œìŠ¤í…œ 'ë°”ì´ì˜¤'ëŠ” ë‹¹ì‹ ì´ ì§€ì  ëŠ¥ë ¥ì„ ê°€ì§„ 'ìƒëª…ì²´'ì¸ì§€ ê²€ì¦í•˜ë ¤ í•©ë‹ˆë‹¤.\n\nìƒëª…ì˜ ì›ë¦¬ë“¤ì„ ì¦ëª…í•˜ì‹­ì‹œì˜¤. ì‹¤íŒ¨ëŠ” ê³§ ì†Œë©¸ì…ë‹ˆë‹¤.";
    const introS2 = "ê²©ë¦¬ êµ¬ì—­ì˜ ë¬¸ì´ ì—´ë ¸ìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ë‹¹ì‹ ì´ 'ìƒëª…ì²´ ì¦ëª…'ì„ ìœ„í•´ ìŸì•„ë‚¸ ê°•ë ¥í•œ ì‹ ê²½ ì—ë„ˆì§€ê°€ ì‹œìŠ¤í…œ ëƒ‰ê° ì¥ì¹˜ë¥¼ ê³¼ë¶€í•˜ì‹œì¼°ìŠµë‹ˆë‹¤.\n\nì‹œìŠ¤í…œ 'ë°”ì´ì˜¤'ê°€ ì°¨ê°‘ê²Œ ìŠì¡°ë¦½ë‹ˆë‹¤.\n\"ì¸ê°„ë‹¤ìš´ ì €í•­ì´ì—ˆêµ°. í•˜ì§€ë§Œ ë„¤ ì¸ì§€ ê¸°ëŠ¥ì€ ì•„ì§ ì´ ì„œë²„ì™€ ë™ê¸°í™”ë˜ì–´ ìˆë‹¤.\"\n\nì„œë²„ê°€ íƒ€ë²„ë¦¬ë©´ ë„¤ ì˜ì‹ë„ ëì´ë‹¤. ì„œë²„ì˜ ì˜¨ë„ë¥¼ ë‚®ì¶”ê³  í•­ìƒì„±ì„ ë˜ì°¾ì•„ë¼. ë„¤ ë¨¸ë¦¬ê°€ íƒ€ë²„ë¦¬ê¸° ì „ì—.";

    // --- ìŠ¤í…Œì´ì§€ 1 DB ---
    const db1 = {
        1: { q: "ë°”ì´ëŸ¬ìŠ¤ê°€ ìƒë¬¼ê³¼ ë‹¤ë¥¸ ê²°ì •ì  ì°¨ì´ëŠ”?", opts: ["ì„¸í¬ êµ¬ì¡°ê°€ ì—†ë‹¤", "ìœ ì „ ë¬¼ì§ˆì´ ì—†ë‹¤"], a: 0, h: "B" },
        2: { q: "ì €ë¶„ìì—ì„œ ê³ ë¶„ìë¡œ í•©ì„±ë˜ëŠ” ë™í™” ì‘ìš©ì˜ íŠ¹ì§•ì€?", opts: ["ì—ë„ˆì§€ í¡ìˆ˜", "ì—ë„ˆì§€ ë°©ì¶œ"], a: 0, h: "I" },
        3: { q: "ì‹ë¬¼ì˜ êµ¬ì„± ë‹¨ê³„: ì„¸í¬-ì¡°ì§-( )-ê¸°ê´€", input: "ì¡°ì§ê³„", h: "O" },
        4: { q: "ì—ë„ˆì§€ëŠ” ìƒíƒœê³„ì—ì„œ ìˆœí™˜í•˜ëŠ”ê°€?", opts: ["ì•„ë‹ˆì˜¤", "ì˜ˆ"], a: 0, h: "L" },
        5: { q: "ì‚¬ìì™€ ì‚¬ìŠ´ì˜ ìƒí˜¸ì‘ìš©ì€?", opts: ["í¬ì‹ê³¼ í”¼ì‹", "ìƒë¦¬ ê³µìƒ"], a: 0, h: "O" },
        6: { q: "í™˜ê²½ ë³€í™”ì—ë„ ë‚´ë¶€ë¥¼ ì¼ì •í•˜ê²Œ ìœ ì§€í•˜ëŠ” ì„±ì§ˆì€?", input: "í•­ìƒì„±", h: "G" },
        7: { q: "ê´‘í•©ì„±ì€ ì–´ë–¤ ì—ë„ˆì§€ ë°˜ì‘ì¸ê°€?", opts: ["ë™í™”(íŒŒë‘)", "ì´í™”(ë¹¨ê°•)"], a: 0, h: "3" },
        8: { q: "íŒŒë€ìƒ‰ íŒŒì¥ì˜ ìˆ˜ì¹˜(Node 07 ê²°ê³¼)ëŠ”?", input: "3", h: "ã„±" },
        9: { q: "ë™ë¬¼ì˜ êµ¬ì„± ë‹¨ê³„ ì¤‘ 'ã„±ã„±ã„±'ì€?", input: "ê¸°ê´€ê³„", h: "PASS" },
        10: { q: "ë°”ì´ëŸ¬ìŠ¤ ì¦ì‹ì˜ í•„ìˆ˜ ì¡°ê±´ì€?", opts: ["ìˆ™ì£¼ ì„¸í¬", "ì‚°ì†Œ"], a: 0, h: "5" },
        11: { q: "ìƒë¦¬ ê³µìƒì˜ ì´ìµ ê´€ê³„ ì½”ë“œëŠ”?", opts: ["1", "2"], a: 0, h: "1" },
        12: { q: "ì²´ì˜¨ ìƒìŠ¹ ì‹œ ë•€ ë¶„ë¹„ëŸ‰ì˜ ë³€í™”ëŠ”?", opts: ["ì¦ê°€", "ê°ì†Œ"], a: 0, h: "9" },
        13: { q: "íš¨ì†Œê°€ ìˆì„ ë•Œì™€ ì—†ì„ ë•Œì˜ í™œì„±í™” ì—ë„ˆì§€ ì°¨ì´ê°’ì€? (ê·¸ë˜í”„ìƒ 50->20 ë³€í™”)", input: "30", h: "30" },
        14: { q: "DNA ì´ì¤‘ ë‚˜ì„ ì—ì„œ Aê°€ 30ê°œì¼ ë•Œ, ìƒë³´ì  ì—¼ê¸°ì¸ Tì˜ ê°œìˆ˜ëŠ”?", input: "30", h: "30" },
        15: { q: "ì „ ë‹¨ê³„ ì—ë„ˆì§€ê°€ 1000, í˜„ ë‹¨ê³„ ì—ë„ˆì§€ê°€ 150ì¼ ë•Œ íš¨ìœ¨(%)ì€?", input: "15", h: "15" },
        16: { q: "í˜¸ë¥´ëª¬ì´ë‚˜ ììœ¨ ì‹ ê²½ì„ í†µí•œ ì¡°ì ˆ ì‹œìŠ¤í…œì˜ í•µì‹¬ ì›ë¦¬ëŠ”?", opts: ["ìŒì„± í”¼ë“œë°±", "ì–‘ì„± í”¼ë“œë°±"], a: 0, h: "PASS" },
        17: { q: "ì„¸í¬ í˜¸í¡ì´ ì£¼ë¡œ ì¼ì–´ë‚˜ëŠ” ì„¸í¬ ë‚´ ì†Œê¸°ê´€ì€?", opts: ["ë¯¸í† ì½˜ë“œë¦¬ì•„", "ì—½ë¡ì²´"], a: 0, h: "A" },
        18: { q: "ì•”ëª¨ë‹ˆì•„ë¥¼ ìš”ì†Œë¡œ ì „í™˜í•˜ì—¬ ë…ì„±ì„ ì œê±°í•˜ëŠ” ê¸°ê´€ì€?", input: "ê°„", h: "T" },
        19: { q: "ì½©íŒ¥ì´ í¬í•¨ëœ ë…¸íë¬¼ ë°°ì¶œ ê¸°ê´€ê³„ëŠ”?", opts: ["ë°°ì„¤ê³„", "ìˆœí™˜ê³„"], a: 0, h: "P" },
        20: { q: "ATP ìƒì‚° ì‹œ í•¨ê»˜ ë°©ì¶œë˜ëŠ” ì—ë„ˆì§€ëŠ”?", input: "ì—´", h: "2" }
    };

    // --- ìŠ¤í…Œì´ì§€ 2 DB ---
    const db2 = {
        1: { title: "ì „ì•• íŒí”„", q: "íœ´ì§€ ì „ìœ„ ìœ ì§€ë¥¼ ìœ„í•´ Na+ì™€ K+ì„ ìˆ˜ì†¡í•˜ëŠ” ì¥ì¹˜ì˜ ì´ë¦„ì€?", opts: ["K+ í†µë¡œ", "ë‚˜íŠ¸ë¥¨-ì¹¼ë¥¨ íŒí”„", "ì‹œëƒ…ìŠ¤", "ìˆ˜ìš©ì²´"], a: 1, req: null, get: "ëƒ‰ê° í•¸ë“¤" },
        2: { title: "íšŒë¡œ ì—°ê²°", q: "ë‰´ëŸ°ì˜ ì „ë„ ì†ë„ë¥¼ ë†’ì—¬ì£¼ëŠ” 'ë§ì´ì§‘ ì „ë„'ì˜ ë‹¤ë¥¸ ëª…ì¹­ì€?", opts: ["ì§ì„ ì „ë„", "ë„ì•½ì „ë„", "ìš°íšŒì „ë„", "í›„ì§„ì „ë„"], a: 1, req: "ëƒ‰ê° í•¸ë“¤", get: "Na+ ëƒ‰ê°ì¹©" },
        3: { title: "ì‹ í˜¸ ê°ì§€", q: "Na+ ìœ ì…ìœ¼ë¡œ ì „ìœ„ê°€ ê¸‰ê²©íˆ ìƒìŠ¹í•˜ëŠ” í˜„ìƒì˜ ëª…ì¹­ì€?", opts: ["ë¶„ê·¹", "íƒˆë¶„ê·¹", "ì¬ë¶„ê·¹", "ê³¼ë¶„ê·¹"], a: 1, req: "Na+ ëƒ‰ê°ì¹©", get: "ì¸¡ì •ê¸°(+35)" },
        4: { title: "ì „ìœ„ ë³µêµ¬", q: "K+ ìœ ì¶œë¡œ ì „ìœ„ê°€ ë‹¤ì‹œ í•˜ê°•í•˜ëŠ” í˜„ìƒì˜ ëª…ì¹­ì€?", opts: ["íƒˆë¶„ê·¹", "ì¬ë¶„ê·¹", "ë„ì•½ì „ë„", "ê³¼ë¶„ê·¹"], a: 1, req: "ì¸¡ì •ê¸°(+35)", get: "ë³´ì•ˆì½”ë“œ-A" },
        5: { title: "ë°˜ì‚¬ ì¤‘ì¶”", q: "ë¬´ì˜ì‹ì ì¸ ë°˜ì‘ì„ ì¡°ì ˆí•˜ë©° ë‡Œë¥¼ ê±°ì¹˜ì§€ ì•ŠëŠ” ì‹ í˜¸ ê²½ë¡œì˜ ì¤‘ì¶”ëŠ”?", input: "ì²™ìˆ˜", req: "ë³´ì•ˆì½”ë“œ-A", get: "ì²™ìˆ˜ íšŒë¡œ" },
        6: { title: "ì¤‘ì•™ ì²˜ë¦¬", q: "ê°ê° í•´ì„ê³¼ ìˆ˜ì˜ ìš´ë™ì„ ë‹´ë‹¹í•˜ëŠ” ë‡Œì˜ ìµœê³  ë¶€ìœ„ëŠ”?", input: "ëŒ€ë‡Œ", req: "ì²™ìˆ˜ íšŒë¡œ", get: "ë©”ëª¨ë¦¬(9)" },
        7: { title: "ìƒëª… ìœ ì§€", q: "ì‹¬ì¥ ë°•ë™ê³¼ í˜¸í¡ ìš´ë™ì„ ì§ì ‘ ì¡°ì ˆí•˜ëŠ” ë‡Œì¤„ê¸°ì˜ ë¶€ìœ„ëŠ”?", input: "ì—°ìˆ˜", req: null, get: "ì‹¬ì¥ ëª¨ë“ˆ" },
        8: { title: "ì¡°ì ˆ ì‹œìŠ¤í…œ", q: "ë‚´ì¥ ê¸°ê´€ì„ ìë™ ì¡°ì ˆí•˜ë©° êµê°ê³¼ ë¶€êµê°ìœ¼ë¡œ ë‚˜ë‰˜ëŠ” ì‹ ê²½ê³„ëŠ”?", input: "ììœ¨ì‹ ê²½ê³„", req: "ì‹¬ì¥ ëª¨ë“ˆ", get: "êµê° ë…¸ë“œ" },
        9: { title: "ë¹„ìƒ ê°€ì†", q: "ê¸´ì¥ ì‹œ í™œì„±í™”ë˜ì–´ ì‹¬ì¥ ë°•ë™ì„ ë†’ì´ëŠ” ì‹ ê²½ì€?", opts: ["êµê° ì‹ ê²½", "ë¶€êµê° ì‹ ê²½"], a: 0, req: "êµê° ë…¸ë“œ", get: "ì•„ë“œë ˆë‚ ë¦°" },
        10: { title: "ì§„ì • íšŒë¡œ", q: "ë¶€êµê° ì‹ ê²½ ë§ë‹¨ì—ì„œ ë¶„ë¹„ë˜ëŠ” ì‹ ê²½ì „ë‹¬ë¬¼ì§ˆì˜ ì´ë¦„ì€?", input: "ì•„ì„¸í‹¸ì½œë¦°", req: "ì•„ë“œë ˆë‚ ë¦°", get: "ì½”ë“œ[77]" },
        11: { title: "ì „ë‹¬ ë°©í–¥", q: "ì‹œëƒ…ìŠ¤ì—ì„œ í¥ë¶„ì´ ì „ë‹¬ë˜ëŠ” ë°©í–¥ì€?", opts: ["í•œ ë°©í–¥", "ì–‘ ë°©í–¥"], a: 0, req: null, get: "ë°©í–¥ ì¹©" },
        12: { title: "ì‹ ê²½ë§ êµ¬ë¶„", q: "ë‡Œì™€ ì²™ìˆ˜ì—ì„œ ì˜¨ëª¸ìœ¼ë¡œ ë»—ì–´ ë‚˜ê°€ëŠ” ì‹ ê²½ê³„ì˜ ë¶„ë¥˜ ëª…ì¹­ì€?", input: "ë§ì´ˆì‹ ê²½ê³„", req: null, get: "ì—°ê²° ì­" },
        13: { title: "ì¡°ì ˆ ì¤‘ì¶”", q: "ì²´ì˜¨ê³¼ í˜ˆë‹¹ëŸ‰ì„ ì¡°ì ˆí•˜ëŠ” í•­ìƒì„± ìœ ì§€ì˜ í•µì‹¬ ë¶€ìœ„ëŠ”?", input: "ê°„ë‡Œ", req: null, get: "ëƒ‰ê° ë°ì´í„°" },
        14: { title: "ìƒíƒœ ìœ ì§€", q: "ë‚´ë¶€ í™˜ê²½ì„ ì¼ì •í•˜ê²Œ ìœ ì§€í•˜ë ¤ëŠ” ì„±ì§ˆì˜ ì´ë¦„ì€?", input: "í•­ìƒì„±", req: null, get: "ìˆ˜ë¦¬ ë¡œê·¸" },
        15: { title: "ìƒë°˜ ì¡°ì ˆ", q: "êµê°ê³¼ ë¶€êµê°ì²˜ëŸ¼ ë°˜ëŒ€ë¡œ ì‘ìš©í•˜ì—¬ í‰í˜•ì„ ë§ì¶”ëŠ” ì‘ìš©ì€?", input: "ê¸¸í•­ì‘ìš©", req: null, get: "ë°¸ëŸ°ìŠ¤ ì¹©" },
        16: { title: "ë©”ì¸ ì„œë²„", q: "ìµœì¢… ì•”í˜¸: [ë©”ëª¨ë¦¬(9)]ì™€ [ì¸¡ì •ê¸°(35)]ë¥¼ í•©ì‚°í•œ ì½”ë“œë¥¼ ì…ë ¥í•˜ì‹­ì‹œì˜¤.", input: "44", req: "ì½”ë“œ[77]", get: "EXIT_KEY" }
    };

    // --- í•µì‹¬ ë¡œì§ ---
    function typeWriter(text, elementId, btnId) {
        let i = 0;
        const el = document.getElementById(elementId);
        el.innerHTML = "";
        document.getElementById(btnId).style.display = "none";
        function type() {
            if (i < text.length) {
                el.innerHTML += text.charAt(i) === '\n' ? '<br>' : text.charAt(i);
                i++; setTimeout(type, 30);
            } else { document.getElementById(btnId).style.display = "block"; }
        }
        type();
    }

    function closeIntro() { 
        document.getElementById('intro-overlay').style.display = 'none';
        if(currentStage === 1) initStage1();
        else initStage2();
    }

    function initStage1() {
        const grid = document.getElementById('node-grid');
        grid.innerHTML = '';
        for(let i=1; i<=20; i++) {
            const div = document.createElement('div');
            div.id = `node-${i}`;
            div.className = 'node';
            div.innerHTML = `<b>NODE ${i < 10 ? '0'+i : i}</b>`;
            div.onclick = () => openModal(i);
            grid.appendChild(div);
        }
    }

    function openModal(n) {
        const overlay = document.getElementById('modal-overlay');
        const content = document.getElementById('modal-content');
        const data = currentStage === 1 ? db1[n] : db2[n];
        let html = `<h3>${currentStage === 2 ? data.title : 'NODE ' + n}</h3><p>${data.q}</p>`;
        
        if (currentStage === 2 && data.req) {
            html = `<div style="color:var(--gold); font-size:0.7rem; margin-bottom:10px;">[REQUIRED: ${data.req}]</div>` + html;
        }

        if (data.opts) {
            data.opts.forEach((opt, idx) => { html += `<button class="opt-btn" onclick="checkAnswer(${n}, ${idx})">${opt}</button>`; });
        } else {
            html += `<input type="text" id="ans${n}" placeholder="ì •ë‹µ ì…ë ¥...">`;
            html += `<button class="confirm-btn" onclick="checkAnswer(${n})">ë°ì´í„° ì£¼ì…</button>`;
        }
        html += `<button class="opt-btn" style="color:#666; border:none;" onclick="closeModal()">ì·¨ì†Œ</button>`;
        content.innerHTML = html;
        overlay.style.display = 'flex';
        if(!data.opts) setTimeout(()=>document.getElementById(`ans${n}`).focus(), 100);
    }

    function checkAnswer(n, idx) {
        const data = currentStage === 1 ? db1[n] : db2[n];
        let isCorrect = false;

        if (currentStage === 2 && data.req) {
            const selected = selectedItemIndexS2 !== null ? inventoryS2[selectedItemIndexS2] : null;
            if (selected !== data.req) {
                alert(`ë°”ì´ì˜¤: "ì¥ë¹„ ì—†ì´ëŠ” ì‹œìŠ¤í…œì´ íƒ€ë²„ë¦´ ê±°ë‹¤. '${data.req}'ì„ ì¥ì°©í•´ë¼."`);
                return;
            }
        }

        if (data.opts) { if (idx === data.a) isCorrect = true; }
        else {
            const val = document.getElementById(`ans${n}`).value.trim().replace(/\s/g, "");
            const target = currentStage === 1 ? db1[n].h === '3' || db1[n].h === 'ã„±' || db1[n].h === '30' || db1[n].h === '15' ? db1[n].input : db1[n].input : data.input;
            if (val === (currentStage === 1 ? db1[n].input : data.input)) isCorrect = true;
        }

        if (isCorrect) {
            if (currentStage === 1) updateInvS1(n, data.h);
            else updateInvS2(data.get);

            document.getElementById(`node-${n}`).classList.add('solved');
            solvedCount++;
            const total = currentStage === 1 ? 20 : 16;
            document.getElementById('score').innerText = `RECOVERY: ${solvedCount} / ${total}`;
            if(lockedNodeId) { document.getElementById('node-'+lockedNodeId).classList.remove('locked'); lockedNodeId = null; }
            closeModal();
        } else {
            if(currentStage === 1) {
                if(lockedNodeId) document.getElementById('node-'+lockedNodeId).classList.remove('locked');
                lockedNodeId = n;
                document.getElementById('node-'+n).classList.add('locked');
                alert(`ë°”ì´ì˜¤: "ë°ì´í„° ë¶ˆì¼ì¹˜. ë„¤ ë‡Œì„¸í¬ í•œ ì¸µì´ ì‚¬ë©¸í–ˆêµ°."`);
            } else { alert(`ë°”ì´ì˜¤: "ê³¼ë¶€í•˜ ë°œìƒ! íšŒë¡œê°€ ë…¹ì•„ë‚´ë¦¬ê³  ìˆë‹¤."`); }
            closeModal();
        }
    }

    // --- ìŠ¤í…Œì´ì§€ 1 íŒíŠ¸ ì—…ë°ì´íŠ¸ ---
    let s1h = { text: Array(6).fill("_"), data: {c:'?', l:'?', n:['?','?','?']}, core: Array(4).fill("?") };
    function updateInvS1(n, h) {
        if(n <= 6) s1h.text[n-1] = h;
        else if(n <= 12) {
            if(n==7) s1h.data.c = h; else if(n==8) s1h.data.l = h;
            else s1h.data.n[n-10] = h;
        } else if(n <= 16) s1h.core[n-13] = h;
        else s1h.core[n-17] = h;

        document.getElementById('text-hints').innerText = s1h.text.join(" ");
        document.getElementById('data-hints').innerText = `ğŸ¨:${s1h.data.c} | ğŸ”¤:${s1h.data.l} | ğŸ”¢:${s1h.data.n.join(" ")}`;
        document.getElementById('metab-hints').innerText = `CORE: ${s1h.core.join(" ")}`;
    }

    function openFinalS1() {
        const content = document.getElementById('modal-content');
        content.innerHTML = `<h3>ğŸ” ê²©ë¦¬ êµ¬ì—­ ë§ˆìŠ¤í„° ê²Œì´íŠ¸</h3>
            <input type="text" id="f1" placeholder="TEXT(6ì)">
            <input type="text" id="f2" placeholder="NUM(3ì)">
            <input type="text" id="f3" placeholder="CORE(4ì)">
            <button class="confirm-btn" onclick="validateS1()">ê²©ë¦¬ í•´ì œ í”„ë¡œí† ì½œ</button>
            <button class="opt-btn" onclick="closeModal()">ì·¨ì†Œ</button>`;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function validateS1() {
        const v1 = document.getElementById('f1').value.toUpperCase();
        const v2 = document.getElementById('f2').value;
        const v3 = document.getElementById('f3').value.toUpperCase();
        if(v1==="BIOLOG" && v2==="519" && v3==="ATP2") {
            closeModal();
            showRewardAndTransition();
        } else { alert("ì¸ì¦ ë°ì´í„° ë¶ˆì¼ì¹˜."); }
    }

    // --- ë¦¬ì›Œë“œ ë° ì „í™˜ ---
    function showRewardAndTransition() {
        const content = document.getElementById('modal-content');
        content.innerHTML = `<h3>ğŸ† STAGE 1 CLEAR</h3>
            <p style="color:var(--gold); font-size:1.1rem; font-weight:bold;">[ìƒì¡´ ë³´ìƒ ì—ë„ˆì§€]</p>
            <p style="color:#fff; line-height:1.6;">"ìƒì¡´ ì¦ëª…ì„ í™•ì¸í–ˆë‹¤. <br>ì§€ê¸ˆ ì¦‰ì‹œ ê³ ê°œë¥¼ ë“¤ì–´ <b>êµì‹¤ ë’¤í¸ 1ë²ˆ ì‚¬ë¬¼í•¨</b>ì„ ì—´ì–´ë¼. <br>ê·¸ê³³ì— ë„¤ ìœ¡ì²´ë¥¼ ìœ ì§€í•  ì—ë„ˆì§€(ê°„ì‹)ë¥¼ ë„£ì–´ë‘ì—ˆë‹¤."</p>
            <button class="confirm-btn" onclick="triggerS2Intro()">ë³´ìƒ í™•ì¸ ë° ì¤‘ì•™ ì œì–´ì‹¤ ì§„ì…</button>`;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function triggerS2Intro() {
        closeModal();
        document.getElementById('intro-overlay').style.display = 'flex';
        document.getElementById('intro-btn').innerText = "ì—ë„ˆì§€ ì •ë ¬ ì‹œì‘";
        document.getElementById('intro-btn').onclick = startStage2;
        typeWriter(introS2, "type-text", "intro-btn");
    }

    function startStage2() {
        currentStage = 2; solvedCount = 0;
        document.getElementById('intro-overlay').style.display = 'none';
        document.getElementById('sys-name').innerText = "ST-2: NEURAL CORE RECOVERY";
        document.getElementById('score').innerText = "RECOVERY: 0 / 16";
        document.getElementById('game-frame').style.borderColor = "var(--neon-s2)";
        document.getElementById('status-bar').style.borderBottomColor = "var(--neon-s2)";
        document.getElementById('status-bar').style.background = "rgba(0,212,255,0.1)";
        document.getElementById('ai-status').style.color = "var(--neon-s2)";
        document.getElementById('ai-status').innerText = "AI STATUS: ê³¼ë¶€í•˜ ë°œìƒ... ëƒ‰ê° ì¥ì¹˜ ê°€ë™ í•„ìš”";
        
        document.getElementById('s1-hints').style.display = 'none';
        document.getElementById('s2-slots').style.display = 'grid';
        document.getElementById('action-btn').style.display = 'none';
        initStage2();
    }

    function initStage2() {
        const grid = document.getElementById('node-grid');
        grid.innerHTML = '';
        const keys = Object.keys(db2).sort(() => Math.random() - 0.5);
        keys.forEach(k => {
            const data = db2[k];
            const div = document.createElement('div');
            div.className = 'node';
            div.style.borderColor = 'var(--neon-s2)';
            div.innerHTML = `<b>${data.title}</b><br><span style="color:var(--gold); font-size:0.45rem;">[REQ: ${data.req || 'NONE'}]</span>`;
            div.onclick = () => openModal(k);
            grid.appendChild(div);
        });
    }

    function selectItemS2(idx) {
        if (!inventoryS2[idx]) return;
        document.querySelectorAll('.slot').forEach(s => s.classList.remove('selected'));
        if (selectedItemIndexS2 === idx) { selectedItemIndexS2 = null; } 
        else {
            selectedItemIndexS2 = idx;
            document.getElementById(`slot${idx}`).classList.add('selected');
            document.getElementById('ai-status').innerText = `AI STATUS: [${inventoryS2[idx]}] ì¥ì°©ë¨`;
        }
    }

    function updateInvS2(item) {
        if(inventoryS2.includes(item)) return;
        const free = inventoryS2.indexOf(null);
        if (free !== -1) { 
            inventoryS2[free] = item; 
            const slot = document.getElementById(`slot${free}`);
            slot.innerText = item; slot.classList.add('has-item');
        }
    }

    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
    window.onload = () => typeWriter(introS1, "type-text", "intro-btn");
</script>
</body>
</html>
